<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Summary Association Statistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <!-- code for styles for all pages -->
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <!-- sametop bar for all pages -->
    <header class="fixed inset-x-0 top-0 z-50 bg-[#004a6f]">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 h-12 flex items-center justify-between">
            <img src="ukhd_logo.jpg" alt="logo" class="h-8 w-auto bg-white/70 backdrop-blur shadow-sm select-none" />
            <span
                class="rounded-xl bg-white/70 backdrop-blur px-3 py-1 text-xs font-medium shadow-sm select-none text-center">
                ENG
            </span>
        </div>
    </header>

    <!-- Page Content -->
    <main class="layer max-w-8xl mx-auto px-16 lg:px-12 min-h-screen flex flex-col pt-16">
        <div class="grid grid-cols-12 gap-6 mt-10 flex-grow">
            <!-- nav Sidebar navigation -->
            <nav class="col-span-3 sm:col-span-2 md:col-span-1 mt-6">
                <ul class="space-y-3">
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="index.html">Home</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="data.html">Data</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="sources.html">Sources</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="contact.html">Contact</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="about.html">About</a></li>
                </ul>
            </nav>

            <!--Pages: -->
            <section
                class="col-span-8 sm:col-span-9 md:col-span-10 rounded-xl bg-white/40 backdrop-blur border border-gray-500 mt-6 mx-6 shadow-sm">
                <h2 class="text-4xl font-medium leading-tight text-[#004a6f] drop-shadow px-6">Trying out my data:</h2>

                <div class="p-6 grid gap-6">
                    <div id="statsCards" class="grid gap-4 sm:grid-cols-3"></div>
                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">Manhattan</h3>
                        <div id="manhattan-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                        </div>
                    </div>

                    <div class="grid gap-6 sm:grid-cols-2">
                        <div>
                            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">QQ plot</h3>
                            <div id="qq-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">MAF distribution</h3>
                            <div id="maf-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">effect size (log OR with 95% CI)</h3>
                        <div id="effect-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">P-value top 10</h3>
                        <div id="pval-top10-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <footer class="mt-auto text-center text-xs text-gray-800/80 py-4">
            © <span id="year"></span> Summary Association Statistics
        </footer>
    </main>


    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        let RES = null;
        let RAW = []; // normalized SNP rows

        async function loadResults() {
            try {
                const url = 'assets/MA_results_fish1011.json'; // make sure path & case match
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                RES = await res.json();

                // ---- find the primary table ----
                // Supports: {results:[...]}, {manhattan:[...]}, {manhatten:[...]}, or a plain array
                const table =
                    (Array.isArray(RES) && RES) ||
                    RES.results ||
                    RES.manhattan ||
                    RES.manhatten ||
                    [];

                console.log('Loaded JSON keys:', Array.isArray(RES) ? ['<array>'] : Object.keys(RES));
                console.log('Primary table length:', table.length);
                if (!Array.isArray(table) || table.length === 0) {
                    console.warn('No rows found in results/manhattan/manhatten/top-level array.');
                }

                // ---- normalize into RAW ----
                RAW = table.map(d => {
                    const p = d.p_value ?? d.pval ?? d.p;       // accept different p-field names
                    const chr = d.chr ?? d.chrom ?? d.chromosome;
                    const pos = d.position ?? d.pos;
                    return {
                        SNP: d.SNP ?? null,
                        chr: chr != null ? String(chr) : '',
                        position: Number(pos),
                        p: Number(p),
                        posCum: Number.isFinite(d.pos_cum) ? Number(d.pos_cum) : null,
                        neglog: Number.isFinite(d.neglog10p) ? Number(d.neglog10p) : null,
                        MAF: (d.MAF != null ? Number(d.MAF) : null),
                        OR: (d.OR != null ? Number(d.OR) : null),
                        CI_low: (d.CI_low != null ? Number(d.CI_low) : null),
                        CI_high: (d.CI_high != null ? Number(d.CI_high) : null)
                    };
                }).filter(r => r.chr && Number.isFinite(r.position) && Number.isFinite(r.p));

                console.log('Usable rows after normalization:', RAW.length);
                if (!RAW.length) throw new Error('No usable rows (missing chr/position/p).');

                // ---- compute helpers if needed ----
                if (RAW.some(r => r.posCum == null)) {
                    const chrOrder = Array.from(new Set(RAW.map(r => r.chr))).sort(naturalChrSort);
                    const maxPerChr = new Map(chrOrder.map(c => [c, Math.max(...RAW.filter(r => r.chr === c).map(r => r.position))]));
                    let offset = 0;
                    const chrOffset = new Map();
                    chrOrder.forEach(c => { chrOffset.set(c, offset); offset += maxPerChr.get(c) || 0; });
                    RAW.forEach(r => { if (r.posCum == null) r.posCum = (chrOffset.get(r.chr) || 0) + r.position; });
                }
                if (RAW.some(r => r.neglog == null)) {
                    RAW.forEach(r => { if (r.neglog == null && r.p > 0 && r.p <= 1) r.neglog = -Math.log10(r.p); });
                }

                // ---- fallback stats if missing ----
                if (!RES.stats) {
                    const pVals = RAW.map(r => r.p).filter(Number.isFinite);
                    const mafVals = RAW.map(r => r.MAF).filter(Number.isFinite).sort((a, b) => a - b);
                    const medMAF = mafVals.length
                        ? (mafVals.length % 2 ? mafVals[(mafVals.length - 1) / 2]
                            : (mafVals[mafVals.length / 2 - 1] + mafVals[mafVals.length / 2]) / 2)
                        : null;
                    RES.stats = {
                        n_snps: RAW.length,
                        min_p: pVals.length ? Math.min(...pVals) : null,
                        median_maf: medMAF
                    };
                }

                renderAllPlots();
            } catch (error) {
                console.error('Failed to load/parse results JSON:', error);
                ['manhattan-plot', 'qq-plot', 'maf-plot', 'effect-plot', 'pval-top10-plot'].forEach(id => {
                    const plot = document.getElementById(id);
                    if (plot) plot.innerHTML = '<div class="p-4 text-red-800">Failed to load data.</div>';
                });
            }
        }

        function renderAllPlots() {
            renderStats();
            renderManhattan();
            // renderQQ(); renderMAF(); renderEffects(); renderPvalTop10();
        }

        function renderStats() {
            const wrap = document.getElementById('statsCards');
            if (!wrap) return;
            const s = RES?.stats || {};
            const items = [
                { label: 'SNPs', value: s.n_snps ?? RAW.length ?? 0 },
                { label: 'Min p', value: (s.min_p != null && isFinite(s.min_p)) ? Number(s.min_p).toExponential(2) : '—' },
                { label: 'Median MAF', value: (s.median_maf != null) ? Number(s.median_maf).toFixed(3) : '—' }
            ];
            wrap.innerHTML = items.map(i => `
    <div class="bg-white/70 backdrop-blur rounded-xl p-4 shadow-sm border border-gray-300 text-center">
      <div class="text-2xl font-semibold text-[#004a6f]">${i.value}</div>
      <div class="text-sm text-gray-700 mt-1">${i.label}</div>
    </div>
  `).join('');
        }

        function renderManhattan() {
            const plotDiv = document.getElementById('manhattan-plot');
            if (!plotDiv) return;
            if (!RAW.length) { plotDiv.innerHTML = '<div class="p-4">No SNP rows found.</div>'; return; }

            const byChr = new Map();
            RAW.forEach(d => { (byChr.get(d.chr) || byChr.set(d.chr, []).get(d.chr)).push(d); });

            const traces = Array.from(byChr.keys()).sort(naturalChrSort).map((chr, i) => {
                const arr = byChr.get(chr).slice().sort((a, b) => a.posCum - b.posCum);
                return {
                    x: arr.map(d => d.posCum),
                    y: arr.map(d => d.neglog),
                    text: arr.map(d => `${d.SNP ?? ''}<br>chr ${d.chr}:${d.position}<br>p=${d.p}`),
                    hovertemplate: '%{text}<extra></extra>',
                    mode: 'markers',
                    type: 'scattergl',
                    name: `chr ${chr}`,
                    marker: { size: 5, opacity: 0.8 }
                };
            });

            const maxX = Math.max(...RAW.map(d => d.posCum));
            const layout = {
                height: 380,
                margin: { t: 20, r: 10, b: 50, l: 55 },
                xaxis: { title: 'Genomic position (cumulative)', range: [0, maxX] },
                yaxis: { title: '-log10(p)' },
                hovermode: 'closest',
                plot_bgcolor: 'rgba(255,255,255,0)',
                paper_bgcolor: 'rgba(255,255,255,0)',
                legend: { orientation: 'h', y: -0.2 }
            };

            Plotly.newPlot(plotDiv, traces, layout, { responsive: true, displayModeBar: true });
        }

        function naturalChrSort(a, b) {
            const toKey = s => {
                s = String(s).toUpperCase();
                if (s === 'X') return 23;
                if (s === 'Y') return 24;
                if (s === 'MT' || s === 'M') return 25;
                const n = parseInt(s, 10);
                return isNaN(n) ? 26 : n;
            };
            return toKey(a) - toKey(b);
        }

        document.addEventListener('DOMContentLoaded', loadResults);
    </script>

</body>

</html>
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Summary Association Statistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <!-- code for styles for all pages -->
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <!-- sametop bar for all pages -->
    <header class="fixed inset-x-0 top-0 z-50 bg-[#004a6f]">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 h-12 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <!-- Mobile menu button -->
                <button id="mobile-nav-toggle" type="button"
                    class="sm:hidden px-3 py-1 rounded-md backdrop-blur bg-white/70 text-[#004a6f] font-semibold shadow text-center">
                    Menu
                </button>
                <img src="ukhd_logo.jpg" alt="logo"
                    class="h-8 w-auto bg-white/70 backdrop-blur shadow-sm select-none" />
            </div>
            <span
                class="rounded-xl bg-white/70 backdrop-blur px-3 py-1 text-xs text-[#004a6f] font-medium shadow-sm select-none text-center">
                ENG
            </span>
        </div>
    </header>

    <!-- Page Content -->
    <main class="layer max-w-8xl mx-auto px-4 sm:px-6 lg:px-12 min-h-screen flex flex-col pt-16">
        <div class="grid grid-cols-12 gap-6 mt-10 flex-grow">
            <!-- nav Sidebar navigation -->
            <nav class="hidden sm:block sm:col-span-3 md:col-span-2 lg:col-span-2 xl:col-span-1 mt-6">
                <ul class="space-y-3">
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="index.html">Home</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="data.html">Data</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="sources.html">Sources</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="contact.html">Contact</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="about.html">About</a></li>
                </ul>
            </nav>

            <!--Pages: -->
            <section
                class="col-span-12 sm:col-span-9 md:col-span-10 lg:col-span-10 xl:col-span-11 rounded-xl bg-white/40 backdrop-blur border border-gray-500 mt-6 mx-6 shadow-sm">
                <h2 class="text-4xl font-medium leading-tight text-[#004a6f] drop-shadow px-6">Trying out my data:</h2>

                <div class="p-6 grid gap-6">

                    <!-- statistics table -> things to choose -->
                    <div class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur p-4 relative z-20">
                        <div class="flex flex-wrap items-start gap-3 gap-x-6">
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Trait: </label>
                                <select id="f-trait"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Subtrait: </label>
                                <select id="f-subtrait"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Author: </label>
                                <select id="f-author"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Year: </label>
                                <select id="f-year"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Ancestry: </label>
                                <select id="f-ancestry"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[10rem]"></select>
                            </div>
                            <div class="min-w-[12rem]">
                                <label class="block text-xs text-gray-700 mb-1">P-value threshold: </label>
                                <input id="f-pval" type="text" value="all"
                                    class="px-3 py-2 border rounded-lg bg-white/70 w-40" placeholder="e.g. 0.05" />
                                <div class="flex gap-1 mt-1 flex-wrap">
                                    <button data-p="0.05" class="qbtn px-2 py-1 text-xs border rounded-lg">0.05</button>
                                    <button data-p="all" class="qbtn px-2 py-1 text-xs border rounded-lg">All</button>
                                    <button data-p="0.01" class="qbtn px-2 py-1 text-xs border rounded-lg">0.01</button>
                                    <button data-p="0.001"
                                        class="qbtn px-2 py-1 text-xs border rounded-lg">0.001</button>
                                    <button data-p="0.0001"
                                        class="qbtn px-2 py-1 text-xs border rounded-lg">0.0001</button>
                                </div>
                            </div>
                        </div>

                        <!-- choose columns-->
                        <div class="flex items-start gap-2 self-start mt-1">
                            <div class="relative">
                                <button id="colpick-toggle" class="px-3 py-2 border rounded-lg bg-white/70">Select
                                    columns</button>
                                <div id="colpick"
                                    class="absolute left-0 sm:left-auto sm:right-0 mt-2 w-64 max-w-[calc(100vw-2rem)] bg-white border rounded-xl shadow-lg p-3 hidden max-h-64 overflow-auto z-[9999]">
                                </div>
                            </div>
                            <button id="download-btn"
                                class="px-3 py-2 rounded-lg bg-[#004a6f] text-white shadow-sm">Download CSV</button>
                        </div>
                    </div>

                    <!-- 3 important stats (just for the looks and quick info)-->
                    <h4 class="text-xl font-medium leading-tight text-[#004a6f] drop-shadow px-1">On one glance:</h4>
                    <div id="statsCards" class="grid gap-4 sm:grid-cols-4"></div>

                    <!-- create table-->
                    <div class="mt-4 border rounded-xl overflow-hidden">
                        <div class="overflow-auto">
                            <table class="min-w-full text-sm" id="stats-table">
                                <thead class="sticky top-0 z-0 bg-white/80 backdrop-blur">
                                    <tr id="table-head"></tr>
                                </thead>
                                <tbody id="table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                        <div class="flex justify-between items-center px-3 py-2 text-xs">
                            <div id="table-status" class="text-gray-600"></div>
                            <div class="flex items-center gap-2">
                                <label class="text-gray-600">Rows:</label>
                                <select id="per-page" class="px-2 py-1 border rounded-lg bg-white/80">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="250">250</option>
                                    <option value="500">500</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="prev-page" class="px-2 py-1 border rounded-lg">Previous</button>
                                <span id="page-label"></span>
                                <button id="next-page" class="px-2 py-1 border rounded-lg">Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- plots (for now)-->
                <!--
                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">Manhattan</h3>
                        <div id="manhattan-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                        </div>
                    </div>

                    <div class="grid gap-6 sm:grid-cols-2">
                        <div>
                            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">QQ plot</h3>
                            <div id="qq-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">MAF distribution</h3>
                            <div id="maf-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">effect size (log OR with 95% CI)</h3>
                        <div id="effect-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">P-value top 10</h3>
                        <div id="pval-top10-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                        </div>
                    </div>
                    
                </div>-->
            </section>
        </div>

        <!-- Footer -->
        <footer class="mt-auto text-center text-xs text-gray-800/80 py-4">
            © <span id="year"></span> Summary Association Statistics
        </footer>
    </main>


    <!-- Mobile nav overlay & drawer -->
    <div id="mobile-nav" class="sm:hidden fixed inset-0 z-40 bg-black/40 hidden">
        <!-- Slide-in panel -->
        <div class="absolute left-0 top-0 bottom-0 w-64 bg-white/95 shadow-xl p-4 flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <span class="font-semibold text-[#004a6f] text-lg">Menu</span>
                <button id="mobile-nav-close" type="button" class="p-1 rounded-md text-gray-600 hover:bg-gray-100">
                    ✕
                </button>
            </div>
            <ul class="space-y-3">
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="index.html">Home</a></li>
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="data.html">Data</a></li>
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="sources.html">Sources</a></li>
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="contact.html">Contact</a></li>
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="about.html">About</a></li>
            </ul>
        </div>
    </div>


    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        let RES = null;
        let RAW = []; // normalized SNP rows

        // table state 
        const TABLE = {
            page: 1,
            perPage: 10,
            cols: [],
            visibleCols: new Set(),
            filtered: [],
        };


        // notes:
        // - fix filters: ancestry and p-value
        // - maybe change filters according to already used filters e.g. only authors for selected trait etc


        //column definitions
        const ALL_COLS = [
            { key: 'SNP', label: 'SNP', get: r => r.SNP ?? '' },
            { key: 'exposure', label: 'Exposure / Trait', get: r => r.trait ?? r.exposure ?? r.trait_group ?? '' },
            { key: 'subtrait', label: 'Specific trait / Subtrait', get: r => r.sub_trait ?? r.subtrait ?? '' },
            { key: 'effect_allele', label: 'Effect allele', get: r => r.effect_allele ?? r.A1 ?? '' },
            { key: 'minor_allele', label: 'Minor allele', get: r => r.minor_allele ?? '' },
            { key: 'chr', label: 'Chromosome', get: r => r.chr ?? '' },
            { key: 'position', label: 'Position', get: r => r.position ?? '' },
            { key: 'GWAS_ID', label: 'Original GWAS ID', get: r => r.gwas_id ?? '' },
            { key: 'author', label: 'Original Author', get: r => r.author ?? '' },
            { key: 'year', label: 'Original Year', get: r => r.year ?? '' },
            { key: 'original_sample_size', label: 'Original Sample Size', get: r => r.original_sample_size ?? '' },
            { key: 'o_ancestry', label: 'Original Ancestry', get: r => r.original_ancestry ?? '' },
            { key: 'o_maf', label: 'Original MAF', get: r => asNum(r.original_MAF, 3) ?? '' },
            { key: 'o_beta', label: 'Original Beta', get: r => asNum(r.original_beta, 4) },
            { key: 'o_se', label: 'Original SE', get: r => asNum(r.original_sd, 4) },
            { key: 'o_pvalue', label: 'Original p-value', get: r => asP(r.original_p) },
            { key: 'eulat_sample_size', label: 'Eulat Sample Size', get: r => r.eulat_sample_size ?? '' },
            { key: 'eu_ancestry', label: 'Eulat Ancestry', get: r => r.eulat_ancestry ?? '' },
            { key: 'eu_maf', label: 'Eulat MAF', get: r => asNum(r.eulat_MAF, 3) },
            { key: 'eu_beta', label: 'Eulat Beta', get: r => asNum(r.eulat_beta, 4) },
            { key: 'eu_se', label: 'Eulat SE', get: r => asNum(r.eulat_sd, 4) },
            { key: 'eu_p', label: 'Eulat p-value', get: r => asP(r.eulat_p) },
        ];

        //column separations
        const COL_SEPARATORS_LEFT = new Set([
            'GWAS_ID',
            'eulat_sample_size'
        ]);

        function asNum(v, d) { return (v != null && isFinite(v)) ? Number(v).toFixed(d) : ''; }
        function num(v) { return v != null && isFinite(v); }
        function asP(p) { return (p != null && isFinite(p)) ? (p < 0.001 ? p.toExponential(2) : Number(p).toFixed(4)) : ''; }
        function numberify(v) { if (v == null) return null; const n = Number(v); return Number.isFinite(n) ? n : null; }


        async function loadResults() {
            try {
                const path = 'assets/full_MA_results';   // base path
                const extension = '.json';
                const allRows = [];

                let index = 1;

                while (true) {
                    const endNumber = String(index).padStart(2, '0');
                    const url = `${path}${endNumber}${extension}`;

                    console.log(`Trying to load: ${url}`);

                    let res;
                    try {
                        res = await fetch(url, { cache: 'no-store' });
                    } catch (err) {
                        console.log(`Network error for ${url}, assuming no more files.`);
                        break;
                    }

                    if (!res.ok) {
                        console.log(`No more files found after index ${index - 1}. Stopping load. Status: ${res.status} `);
                        break;
                    }

                    const json = await res.json();
                    const table = Array.isArray(json) ? json : [];
                    console.log(`Loaded from ${url}, raw rows: ${table.length}`);

                    table.forEach(d => {
                        const original_p = d.original_p;
                        const eulat_p = d.eulat_p ?? d.eulat_p_value;;
                        const original_p_n = numberify(d.original_p);
                        const eulat_p_n = numberify(d.eulat_p ?? d.eulat_p_value); // <-- correct key
                        const p_u = Number.isFinite(original_p_n) ? original_p_n : eulat_p_n;
                        const chr = d.chr;
                        const pos = d.position ?? d.pos;

                        const num = v => (v == null ? null : (Number(v))); //easyer to read later
                        const isNum = v => Number.isFinite(v);
                        const row = {
                            SNP: d.SNP ?? d.rsid ?? null,
                            exposure: d.exposure ?? d.trait_group ?? d.trait ?? null,
                            subtrait: d.subtrait ?? d.sub_trait ?? null,
                            effect_allele: d.effect_allele ?? d.A1 ?? null,
                            minor_allele: d.non_effect_allele ?? d.minor_allele ?? d.A2 ?? null,
                            chr: chr != null ? String(chr) : '',
                            position: Number(pos),

                            gwas_id: d.GWAS_ID ?? d.gwas_id ?? null,
                            author: d.author ?? null,
                            year: d.year != null ? normalizeYear(d.year) : null,
                            original_sample_size: d.original_sample_size ?? null,
                            original_ancestry: d.original_ancestry ?? d.o_ancestry ?? null,
                            original_MAF: numberify(d.original_MAF ?? d.o_maf),
                            original_beta: numberify(d.original_beta ?? d.o_beta),
                            original_sd: numberify(d.original_sd ?? d.o_se),
                            original_p: original_p_n,

                            eulat_sample_size: d.eulat_sample_size ?? null,
                            eulat_ancestry: d.eulat_ancestry ?? d.eu_ancestry ?? null,
                            eulat_MAF: numberify(d.eulat_MAF ?? d.eu_maf),
                            eulat_beta: numberify(d.eulat_beta ?? d.eu_beta),
                            eulat_sd: numberify(d.eulat_sd ?? d.eulat_std_error ?? d.eu_se),
                            eulat_p: eulat_p_n,

                            // convenience fields used by filters/stats
                            publication: d.publication ?? (d.author || d.year ? `${d.author ?? ''} ${d.year ?? ''}`.trim() : null),
                            ancestry: d.original_ancestry ?? d.eulat_ancestry ?? null,
                            MAF: Number.isFinite(num(d.original_MAF)) ? num(d.original_MAF) : num(d.eulat_MAF),
                            p: p_u,

                            posCum: d.posCum != null ? Number(d.posCum) : null, //precomputed
                            neglog: d.neglog != null ? Number(d.neglog) : null, //precomputed
                        };
                        // keep only rows with valid chr, position and p
                        allRows.push(row);
                    });
                    index++;
                }

                RAW = allRows;
                console.log('Total usable rows after loading all files:', RAW.length);

                if (!RAW.length) {
                    throw new Error('No usable rows (missing chr/position/p) across all files.');
                }

                // helpers
                if (RAW.some(r => r.posCum == null)) {
                    const chrOrder = Array.from(new Set(RAW.map(r => r.chr))).sort(naturalChrSort);
                    const maxPerChr = new Map(chrOrder.map(c => [c, Math.max(...RAW.filter(r => r.chr === c).map(r => r.position))]));
                    let offset = 0;
                    const chrOffset = new Map();
                    chrOrder.forEach(c => { chrOffset.set(c, offset); offset += maxPerChr.get(c) || 0; });
                    RAW.forEach(r => { if (r.posCum == null) r.posCum = (chrOffset.get(r.chr) || 0) + r.position; });
                }
                if (RAW.some(r => r.neglog == null)) {
                    RAW.forEach(r => {
                        if (r.neglog == null && r.p > 0 && r.p <= 1) r.neglog = -Math.log10(r.p);
                    });
                }

                if (!RES || typeof RES !== 'object') {
                    RES = {};
                }

                // fallback stats
                if (!RES.stats) {
                    const pVals = RAW.map(r => r.p).filter(Number.isFinite);
                    const mafVals = RAW.map(r => r.MAF).filter(Number.isFinite).sort((a, b) => a - b);
                    const medMAF = mafVals.length
                        ? (mafVals.length % 2 ? mafVals[(mafVals.length - 1) / 2]
                            : (mafVals[mafVals.length / 2 - 1] + mafVals[mafVals.length / 2]) / 2)
                        : null;

                    const absEffects = RAW.map(r => {
                        const v = r.Beta != null
                            ? Math.abs(r.Beta)
                            : (r.OR != null ? Math.abs(Math.log(r.OR)) : null);
                        return (v != null && isFinite(v)) ? v : null;
                    }).filter(Number.isFinite).sort((a, b) => a - b);

                    const medAbsEffect = absEffects.length
                        ? (absEffects.length % 2
                            ? absEffects[(absEffects.length - 1) / 2]
                            : (absEffects[absEffects.length / 2 - 1] + absEffects[absEffects.length / 2]) / 2)
                        : null;

                    RES.stats = {
                        n_snps: RAW.length,
                        min_p: pVals.length ? Math.min(...pVals) : null,
                        median_maf: medMAF,
                        median_abs_effect: medAbsEffect
                    };

                }

                //init table columns
                TABLE.cols = ALL_COLS;
                TABLE.visibleCols = new Set(ALL_COLS.map(c => c.key));
                buildColumnPicker();

                //build filters + render
                buildFilters();
                applyFilters();
                renderAllPlots();

            } catch (error) {
                console.error('Failed to load/parse results JSON:', error);
                ['manhattan-plot', 'qq-plot', 'maf-plot', 'effect-plot', 'pval-top10-plot'].forEach(id => {
                    const plot = document.getElementById(id);
                    if (plot) plot.innerHTML = '<div class="p-4 text-red-800">Failed to load data.</div>';
                });
                const tb = document.getElementById('table-body');
                if (tb) tb.innerHTML = '<tr><td class = "p-3 text-red-800">Failed to load (table) data.</td></tr>';
            }
        }


        function renderAllPlots() {
            renderStats();
            renderManhattan();
            // renderQQ(); renderMAF(); renderEffects(); renderPvalTop10();
        }

        function median(sortedArray) {
            if (!sortedArray.length) return null;
            const mid = Math.floor(sortedArray.length / 2);
            return (sortedArray.length % 2)
                ? sortedArray[mid]
                : (sortedArray[mid - 1] + sortedArray[mid]) / 2;
        }

        // get all info from the rows that were selected in the filters earlier
        function computeStatsFromFilters(rows) {
            const n_snps = rows.length;

            //min pvalue from original and eulat
            const o_pVals = rows.map(r => r.original_p).filter(Number.isFinite);
            const o_min_p = o_pVals.length ? Math.min(...o_pVals) : null;
            const o_mafVals = rows.map(r => r.original_MAF).filter(Number.isFinite).sort((a, b) => a - b);
            const o_median_maf = median(o_mafVals);
            const eu_pVals = rows.map(r => r.eulat_p).filter(Number.isFinite);
            const eu_min_p = eu_pVals.length ? Math.min(...eu_pVals) : null;
            const eu_mafVals = rows.map(r => r.eulat_MAF).filter(Number.isFinite).sort((a, b) => a - b);
            const eu_median_maf = median(eu_mafVals);

            const o_absEffects = rows
                .map(r => (Number.isFinite(r.original_beta) ? Math.abs(r.original_beta) : null))
                .filter(Number.isFinite)
                .sort((a, b) => a - b);
            const o_median_abs_effect = median(o_absEffects);

            const eu_absEffects = rows
                .map(r => (Number.isFinite(r.eulat_beta) ? Math.abs(r.eulat_beta) : null))
                .filter(Number.isFinite)
                .sort((a, b) => a - b);
            const eu_median_abs_effect = median(eu_absEffects);

            return {
                n_snps,
                o_min_p,
                eu_min_p,
                o_median_maf,
                eu_median_maf,
                o_median_abs_effect,
                eu_median_abs_effect,
            };
        }

        function fmtP(p) {
            return (p != null && Number.isFinite(p)) ? (p < 0.001 ? p.toExponential(2) : Number(p).toFixed(4)) : '—';
        }
        function fmtN(x, d) {
            return (x != null && Number.isFinite(x)) ? Number(x).toFixed(d) : '—';
        }

        function renderStats() {
            const wrap = document.getElementById('statsCards');
            if (!wrap) return;
            // Use filtered rows if available, otherwise all rows like before
            const rows = (TABLE.filtered && TABLE.filtered.length)
                ? TABLE.filtered
                : RAW;
            const s = computeStatsFromFilters(rows);
            const items = [
                {
                    key: 'n_snps',
                    label: 'SNPs',
                    value: s.n_snps ?? RAW.length ?? 0,
                    top: `${s.n_snps ?? 0}`,
                    bottom: '',
                    help: 'Number of SNP rows in the current selection (after all filters and p-value threshold) (original vs Eulat).'
                },
                {
                    key: 'min_p',
                    label: 'Min p-value',
                    value: (s.o_min_p != null && isFinite(s.o_min_p)) ? Number(s.o_min_p).toExponential(2) : '—',
                    top: `Original: ${fmtP(s.o_min_p)}`,
                    bottom: `Eulat: ${fmtP(s.eu_min_p)}`,
                    help: 'Minimum p-value in the current selection (after all filters and p-value threshold)( original vs Eulat).'
                },
                {
                    key: 'median_maf',
                    label: 'Median MAF',
                    top: `Original: ${fmtN(s.o_median_maf, 3)}`,
                    bottom: `Eulat: ${fmtN(s.eu_median_maf, 3)}`,
                    value: (s.o_median_maf != null) ? Number(s.o_median_maf).toFixed(3) : '—',
                    help: 'Median minor allele frequency (MAF) in the current selection (after all filters and p-value threshold) (original vs Eulat).'
                },
                {
                    key: 'median_abs_effect',
                    label: 'Median absolute effect',
                    top: `Original: ${fmtN(s.o_median_abs_effect, 4)}`,
                    bottom: `Eulat: ${fmtN(s.eu_median_abs_effect, 4)}`,
                    value: (s.o_median_abs_effect != null) ? Number(s.o_median_abs_effect).toFixed(4) : '—',
                    help: 'Median absolute effect size (|Beta| or |log(OR)|) in the current selection (after all filters and p-value threshold) (original vs Eulat).'
                }
            ];
            wrap.innerHTML = items.map(c => `
        <div class="bg-white/70 backdrop-blur rounded-lg p-3 shadow-sm border border-gray-300 text-center">
            <div class="text-sm font-semibold text-[#004a6f]">${c.top}</div>
                 ${c.bottom ? `<div class="text-sm font-semibold text-[#004a6f] mt-1">${c.bottom}</div>` : ''}
                <div class="text-sm text-gray-700 mt-2 flex items-center justify-center gap-1">
                <span>${c.label}</span>
                    <button type="button"
                    class="w-4 h-4 flex items-center justify-center rounded-full border border-gray-400 text-[10px] leading-none text-gray-600 hover:bg-gray-100"
                title="${c.help}">i</button>
                 </div>
            </div>
        `).join('');
        }



        function renderManhattan() {
            const plotDiv = document.getElementById('manhattan-plot');
            if (!plotDiv) return;
            if (!RAW.length) { plotDiv.innerHTML = '<div class="p-4">No SNP rows found.</div>'; return; }

            const byChr = new Map();
            RAW.forEach(d => { (byChr.get(d.chr) || byChr.set(d.chr, []).get(d.chr)).push(d); });

            const traces = Array.from(byChr.keys()).sort(naturalChrSort).map((chr, i) => {
                const arr = byChr.get(chr).slice().sort((a, b) => a.posCum - b.posCum);
                return {
                    x: arr.map(d => d.posCum),
                    y: arr.map(d => d.neglog),
                    text: arr.map(d => `${d.SNP ?? ''}<br>chr ${d.chr}:${d.position}<br>p=${d.p}`),
                    hovertemplate: '%{text}<extra></extra>',
                    mode: 'markers',
                    type: 'scattergl',
                    name: `chr ${chr}`,
                    marker: { size: 5, opacity: 0.8 }
                };
            });

            const maxX = Math.max(...RAW.map(d => d.posCum));
            const layout = {
                height: 380,
                margin: { t: 20, r: 10, b: 50, l: 55 },
                xaxis: { title: 'Genomic position (cumulative)', range: [0, maxX] },
                yaxis: { title: '-log10(p)' },
                hovermode: 'closest',
                plot_bgcolor: 'rgba(255,255,255,0)',
                paper_bgcolor: 'rgba(255,255,255,0)',
                legend: { orientation: 'h', y: -0.2 }
            };

            Plotly.newPlot(plotDiv, traces, layout, { responsive: true, displayModeBar: true });
        }

        function naturalChrSort(a, b) {
            const toKey = s => {
                s = String(s).toUpperCase();
                if (s === 'X') return 23;
                if (s === 'Y') return 24;
                if (s === 'MT' || s === 'M') return 25;
                const n = parseInt(s, 10);
                return isNaN(n) ? 26 : n;
            };
            return toKey(a) - toKey(b);
        }

        //filters ? table:
        function uniq(list) { return Array.from(new Set(list.filter(Boolean))).sort((a, b) => String(a).localeCompare(String(b))); }

        function buildFilters() {
            const fx = document.getElementById('f-trait');
            const fs = document.getElementById('f-subtrait');
            const fauth = document.getElementById('f-author');
            const fy = document.getElementById('f-year');
            const fa = document.getElementById('f-ancestry');


            [fx, fs, fauth, fy, fa].forEach(sel => {
                if (!sel) return;
                sel.addEventListener('change', () => {
                    TABLE.page = 1;
                    applyFilters();
                });
            });
            //pvalue buttons
            document.querySelectorAll('.qbtn').forEach(btn => btn.addEventListener('click', () => {
                document.getElementById('f-pval').value = btn.dataset.p;
                TABLE.page = 1; applyFilters();
            }));

            // pvalue input
            const pIn = document.getElementById('f-pval');
            if (pIn) {
                pIn.addEventListener('input', () => {
                    TABLE.page = 1;
                    applyFilters();
                });
            }
            // Paging buttons
            document.getElementById('prev-page')?.addEventListener('click', () => { if (TABLE.page > 1) { TABLE.page--; renderTable(); } });
            document.getElementById('next-page')?.addEventListener('click', () => { const maxPage = Math.max(1, Math.ceil(TABLE.filtered.length / TABLE.perPage)); if (TABLE.page < maxPage) { TABLE.page++; renderTable(); } });

            //choice of rows per page
            const per = document.getElementById('per-page');

            if (per) {
                per.value = String(TABLE.perPage); // sync default
                per.addEventListener('change', () => {
                    TABLE.perPage = Number(per.value) || 10;
                    TABLE.page = 1;
                    renderTable();
                    renderStats();
                });
            }

            //download button
            document.getElementById('download-btn').addEventListener('click', downloadCSV);

            // Column picker toggle
            document.getElementById('colpick-toggle').addEventListener('click', () => {
                document.getElementById('colpick').classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                const p = document.getElementById('colpick');
                const b = document.getElementById('colpick-toggle');
                if (!p.contains(e.target) && !b.contains(e.target)) p.classList.add('hidden');
            });
            updateFilterOptions();
        }

        function applyFilters() {
            const f = getFilters();

            TABLE.filtered = RAW.filter(r => {
                if (f.trait && (r.exposure ?? '') !== f.trait) return false;
                if (f.subtrait && (r.subtrait ?? '') !== f.subtrait) return false;
                if (f.author && (r.author ?? '') !== f.author) return false;
                if (f.year && String(r.year ?? '') !== String(f.year)) return false;
                if (f.ancestry && (r.ancestry ?? '') !== f.ancestry) return false;
                if (f.pmax != null && Number.isFinite(f.pmax) && Number.isFinite(r.p) && r.p > f.pmax) return false;
                return true;
            });
            TABLE.page = 1; //go to first page again after filtering
            updateFilterOptions();
            renderTable();
            renderStats(); //update stats if filters are changes
        }

        function buildColumnPicker() {
            const host = document.getElementById('colpick');
            host.innerHTML = TABLE.cols.map(col => `
        <label class="flex items-center gap-2 px-1 py-1 text-sm">
          <input type="checkbox" data-col="${col.key}" ${TABLE.visibleCols.has(col.key) ? 'checked' : ''} />
          <span>${col.label}</span>
        </label>
      `).join('');
            host.querySelectorAll('input[type="checkbox"]').forEach(chk => {
                chk.addEventListener('change', (e) => {
                    const key = e.target.dataset.col;
                    if (e.target.checked) TABLE.visibleCols.add(key); else TABLE.visibleCols.delete(key);
                    renderTable();
                });
            });
        }

        function renderTable() {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');
            const cols = TABLE.cols.filter(c => TABLE.visibleCols.has(c.key));
            const cellClass = (key) =>
                `text-left px-3 py-2 whitespace-nowrap` +
                (COL_SEPARATORS_LEFT.has(key) ? ' border-l-2 border-gray-400' : '');
            head.innerHTML = cols
                .map(c => `<th class="${cellClass(c.key)} font-semibold bg-white/80 backdrop-blur">${c.label}</th>`)
                .join('');
            const start = (TABLE.page - 1) * TABLE.perPage;
            const rows = TABLE.filtered.slice(start, start + TABLE.perPage);
            body.innerHTML = rows.map(r => `
                <tr class="odd:bg-white even:bg-gray-50/70">
                    ${cols.map(c => `<td class="${cellClass(c.key)}">${escapeHtml(display(c.get(r)))}</td>`).join('')}
                </tr>
            `).join('');

            const maxPage = Math.max(1, Math.ceil(TABLE.filtered.length / TABLE.perPage));
            document.getElementById('page-label').textContent = `Page ${TABLE.page} / ${maxPage}`;
            document.getElementById('table-status').textContent = `${TABLE.filtered.length.toLocaleString()} rows` + (TABLE.filtered.length !== RAW.length ? ' (filtered)' : '');
        }

        function downloadCSV() {
            const cols = TABLE.cols.filter(c => TABLE.visibleCols.has(c.key));
            const header = cols.map(c => csvEscape(c.label)).join(',');
            const lines = TABLE.filtered.map(r => cols.map(c => csvEscape(c.get(r))).join(','));
            const csv = [header, ...lines].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'summary_statistics.csv';
            document.body.appendChild(a); a.click(); a.remove();
        }

        function csvEscape(v) {
            if (v == null) return '';
            const s = String(v);
            if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
            return s;
        }

        function parseSci(txt) {
            if (!txt) return null;
            const t = String(txt).trim();
            if (t.toLowerCase() === 'all') return 1;
            const n = Number(t);
            if (!isNaN(n)) return n;
            // accept like 5e-8 with spaces
            const m = t.match(/^([0-9]*\.?[0-9]+)\s*e\s*([+-]?\d+)$/i);
            if (m) return Number(m[1]) * Math.pow(10, Number(m[2]));
            return null;
        }

        function display(v, dash = '—') {
            if (v == null) return dash;
            const s = String(v).trim();
            return s === '' ? dash : s;
        }

        function getFilters() {
            return {
                trait: document.getElementById('f-trait')?.value || '',
                subtrait: document.getElementById('f-subtrait')?.value || '',
                author: document.getElementById('f-author')?.value || '',
                year: document.getElementById('f-year')?.value || '',
                ancestry: document.getElementById('f-ancestry')?.value || '',
                pmax: parseSci(document.getElementById('f-pval')?.value?.trim() || '')
            };
        }

        function rowsMatchingFilters(filters, excludeKey = null) {
            return RAW.filter(r => {
                if (excludeKey !== 'trait' && filters.trait && (r.exposure ?? '') !== filters.trait) return false;
                if (excludeKey !== 'subtrait' && filters.subtrait && (r.subtrait ?? '') !== filters.subtrait) return false;
                if (excludeKey !== 'author' && filters.author && (r.author ?? '') !== filters.author) return false;
                if (excludeKey !== 'year' && filters.year && String(r.year ?? '') !== String(filters.year)) return false;
                if (excludeKey !== 'ancestry' && filters.ancestry && (r.ancestry ?? '') !== filters.ancestry) return false;

                // keep p-value threshold affecting dropdown options too (usually desired)
                if (excludeKey !== 'pmax' && filters.pmax != null && Number.isFinite(filters.pmax) && Number.isFinite(r.p) && r.p > filters.pmax) return false;

                return true;
            });
        }

        function fillSelect(sel, values, label, keepValue = '') {
            const opts = [`<option value="">All ${label}</option>`]
                .concat(values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
            sel.innerHTML = opts.join('');
            if (keepValue && values.includes(keepValue)) sel.value = keepValue;
            else sel.value = '';
        }

        function uniqSorted(list) {
            return Array.from(new Set(list.filter(v => v != null && String(v).trim() !== '')))
                .map(v => String(v))
                .sort((a, b) => a.localeCompare(b));
        }

        function updateFilterOptions() {
            const f = getFilters();
            const fx = document.getElementById('f-trait');
            const fs = document.getElementById('f-subtrait');
            const fa = document.getElementById('f-author');
            const fy = document.getElementById('f-year');
            const fan = document.getElementById('f-ancestry');
            const traitRows = rowsMatchingFilters(f, 'trait');
            const subtraitRows = rowsMatchingFilters(f, 'subtrait');
            const authorRows = rowsMatchingFilters(f, 'author');
            const yearRows = rowsMatchingFilters(f, 'year');
            const ancestryRows = rowsMatchingFilters(f, 'ancestry');
            const traits = uniqSorted(traitRows.map(r => r.exposure));
            const subtraits = uniqSorted(subtraitRows.map(r => r.subtrait));
            const authors = uniqSorted(authorRows.map(r => r.author));
            const years = uniqSorted(yearRows.map(r => r.year)).sort((a, b) => Number(a) - Number(b));
            const ancestries = uniqSorted(ancestryRows.map(r => r.ancestry));
            fillSelect(fx, traits, 'traits', f.trait);
            fillSelect(fs, subtraits, 'subtraits', f.subtrait);
            fillSelect(fa, authors, 'authors', f.author);
            fillSelect(fy, years, 'years', f.year);
            fillSelect(fan, ancestries, 'ancestries', f.ancestry);
        }


        function normalizeYear(year) {
            const n = Number(year);
            if (!Number.isFinite(n)) return null;
            if (n >= 1800 && n <= 2200) return Math.round(n);
            if (n > 20000 && n < 800000) return excelDateToReadable(n);
            return null;
        }
        function excelDateToReadable(date) {
            const base = new Date(Date.UTC(1899, 11, 30)); // Excel base Windows
            const d = new Date(base.getTime() + date * 86400000);
            return d.getUTCFullYear();
        }
        function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c])); }
        document.addEventListener('DOMContentLoaded', loadResults);
        const path = location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('a[href]').forEach(a => {
            if (a.getAttribute('href') === path) {
                a.classList.add('ring-2', 'ring-[#004a6f]', 'border-[#004a6f]');
            }
        });
        // Mobile nav toggle
        const mobileNav = document.getElementById('mobile-nav');
        const openBtn = document.getElementById('mobile-nav-toggle');
        const closeBtn = document.getElementById('mobile-nav-close');

        if (mobileNav && openBtn && closeBtn) {
            function openNav() {
                mobileNav.classList.remove('hidden');
            }

            function closeNav() {
                mobileNav.classList.add('hidden');
            }

            openBtn.addEventListener('click', openNav);
            closeBtn.addEventListener('click', closeNav);

            // close when clicking outside the drawer
            mobileNav.addEventListener('click', (e) => {
                if (e.target === mobileNav) {
                    closeNav();
                }
            });

            // close after clicking a link in mobile menu
            mobileNav.querySelectorAll('a[href]').forEach(a => {
                a.addEventListener('click', closeNav);
            });
        }

    </script>

</body>

</html>
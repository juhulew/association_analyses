<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Summary Association Statistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <!-- code for styles for all pages -->
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <!-- sametop bar for all pages -->
    <header class="fixed inset-x-0 top-0 z-50 bg-[#004a6f]">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 h-12 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <!-- Mobile menu button -->
                <button id="mobile-nav-toggle" type="button"
                    class="sm:hidden px-3 py-1 rounded-md backdrop-blur bg-white/70 text-[#004a6f] font-semibold shadow text-center">
                    Menu
                </button>
                <img src="ukhd_logo.jpg" alt="logo"
                    class="h-8 w-auto bg-white/70 backdrop-blur shadow-sm select-none" />
            </div>
            <span
                class="rounded-xl bg-white/70 backdrop-blur px-3 py-1 text-xs text-[#004a6f] font-medium shadow-sm select-none text-center">
                ENG
            </span>
        </div>
    </header>

    <!-- Page Content -->
    <main class="layer max-w-8xl mx-auto px-4 sm:px-6 lg:px-12 min-h-screen flex flex-col pt-16">
        <div class="grid grid-cols-12 gap-6 mt-10 flex-grow">
            <!-- nav Sidebar navigation -->
            <nav class="hidden sm:block sm:col-span-3 md:col-span-2 lg:col-span-2 xl:col-span-1 mt-6">
                <ul class="space-y-3">
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="index.html">Home</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="data.html">Data</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="sources.html">Sources</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="contact.html">Contact</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 
                                  bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="about.html">About</a></li>
                </ul>
            </nav>

            <!--Pages: -->
            <section
                class="col-span-12 sm:col-span-9 md:col-span-10 lg:col-span-10 xl:col-span-11 rounded-xl bg-white/40 backdrop-blur border border-gray-500 mt-6 mx-6 shadow-sm">
                <h2 class="text-4xl font-medium leading-tight text-[#004a6f] drop-shadow px-6">Trying out my data:</h2>

                <div class="p-6 grid gap-6">

                    <!-- statistics table -> things to choose -->
                    <div class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur p-4 relative z-20">
                        <div class="flex flex-wrap items-start gap-3 gap-x-6">
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Trait: </label>
                                <select id="f-trait"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Subtrait: </label>
                                <select id="f-subtrait"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Author: </label>
                                <select id="f-author"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Year: </label>
                                <select id="f-year"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-700 mb-1">Ancestry: </label>
                                <select id="f-ancestry"
                                    class="px-3 py-2 border rounded-lg bg-white/80 min-w-[10rem]"></select>
                            </div>
                            <div class="min-w-[12rem]">
                                <label class="block text-xs text-gray-700 mb-1">P-value threshold: </label>
                                <input id="f-pval" type="text" value="all"
                                    class="px-3 py-2 border rounded-lg bg-white/70 w-40" placeholder="e.g. 0.05" />
                                <div class="flex gap-1 mt-1 flex-wrap">
                                    <button data-p="0.05" class="qbtn px-2 py-1 text-xs border rounded-lg">0.05</button>
                                    <button data-p="all" class="qbtn px-2 py-1 text-xs border rounded-lg">All</button>
                                    <button data-p="0.01" class="qbtn px-2 py-1 text-xs border rounded-lg">0.01</button>
                                    <button data-p="0.001"
                                        class="qbtn px-2 py-1 text-xs border rounded-lg">0.001</button>
                                    <button data-p="0.0001"
                                        class="qbtn px-2 py-1 text-xs border rounded-lg">0.0001</button>
                                </div>
                            </div>
                        </div>

                        <!-- choose columns-->
                        <div class="flex items-start gap-2 self-start mt-1">
                            <div class="relative">
                                <button id="colpick-toggle" class="px-3 py-2 border rounded-lg bg-white/70">Select
                                    columns</button>
                                <div id="colpick"
                                    class="absolute left-0 sm:left-auto sm:right-0 mt-2 w-64 max-w-[calc(100vw-2rem)] bg-white border rounded-xl shadow-lg p-3 hidden max-h-64 overflow-auto z-[9999]">
                                </div>
                            </div>
                            <button id="download-btn"
                                class="px-3 py-2 rounded-lg bg-[#004a6f] text-white shadow-sm">Download CSV</button>
                        </div>
                    </div>

                    <!-- 3 important stats (just for the looks and quick info)-->
                    <h4 class="text-xl font-medium leading-tight text-[#004a6f] drop-shadow px-1">On one glance:</h4>
                    <div id="statsCards" class="grid gap-4 sm:grid-cols-4"></div>

                    <!-- create table-->
                    <div class="mt-4 border rounded-xl overflow-hidden">
                        <div class="max-h-[420px] overflow-auto">
                            <table class="min-w-full text-sm" id="stats-table">
                                <thead class="sticky top-0 z-0 bg-white/80 backdrop-blur">
                                    <tr id="table-head"></tr>
                                </thead>
                                <tbody id="table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                        <div class="flex justify-between items-center px-3 py-2 text-xs">
                            <div id="table-status" class="text-gray-600"></div>
                            <div class="flex items-center gap-2">
                                <button id="prev-page" class="px-2 py-1 border rounded-lg">Previous</button>
                                <span id="page-label"></span>
                                <button id="next-page" class="px-2 py-1 border rounded-lg">Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- plots (for now)-->
                <!--
                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">Manhattan</h3>
                        <div id="manhattan-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                        </div>
                    </div>

                    <div class="grid gap-6 sm:grid-cols-2">
                        <div>
                            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">QQ plot</h3>
                            <div id="qq-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">MAF distribution</h3>
                            <div id="maf-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">effect size (log OR with 95% CI)</h3>
                        <div id="effect-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">P-value top 10</h3>
                        <div id="pval-top10-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                        </div>
                    </div>
                    
                </div>-->
            </section>
        </div>

        <!-- Footer -->
        <footer class="mt-auto text-center text-xs text-gray-800/80 py-4">
            © <span id="year"></span> Summary Association Statistics
        </footer>
    </main>


    <!-- Mobile nav overlay & drawer -->
    <div id="mobile-nav" class="sm:hidden fixed inset-0 z-40 bg-black/40 hidden">
        <!-- Slide-in panel -->
        <div class="absolute left-0 top-0 bottom-0 w-64 bg-white/95 shadow-xl p-4 flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <span class="font-semibold text-[#004a6f] text-lg">Menu</span>
                <button id="mobile-nav-close" type="button" class="p-1 rounded-md text-gray-600 hover:bg-gray-100">
                    ✕
                </button>
            </div>
            <ul class="space-y-3">
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="index.html">Home</a></li>
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="data.html">Data</a></li>
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="sources.html">Sources</a></li>
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="contact.html">Contact</a></li>
                <li><a class="block text-left px-3 py-2 rounded-lg border border-gray-300 bg-white/80 hover:bg-white"
                        href="about.html">About</a></li>
            </ul>
        </div>
    </div>


    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        let RES = null;
        let RAW = []; // normalized SNP rows

        // table state 
        const TABLE = {
            page: 1,
            perPage: 10,
            cols: [],
            visibleCols: new Set(),
            filtered: [],
        };

        //column definitions
        const ALL_COLS = [
            { key: 'SNP', label: 'SNP', get: r => r.SNP ?? '' },
            { key: 'effect_allele', label: 'Effect Allele', get: r => r.effect_allele ?? '' },
            { key: 'non_effect_allele', label: 'Non-effect Allele', get: r => r.non_effect_allele ?? '' },
            { key: 'trait', label: 'Trait', get: r => r.trait ?? '' }, //TODO
            { key: 'subtrait', label: 'Subtrait', get: r => r.subtrait ?? '' },
            { key: 'chr', label: 'Chromosome', get: r => r.chr ?? '' },
            { key: 'position', label: 'Position', get: r => r.position ?? '' },
            { key: 'maf', label: 'MAF', get: r => asNum(r.MAF, 4) },
            { key: 'beta', label: 'Beta', get: r => asNum(r.Beta, 4) },
            { key: 'sd', label: 'Std Error', get: r => asNum(r.Std_Error, 4) },
            { key: 'or', label: 'Odds Ratio', get: r => asNum(r.OR, 4) },
            { key: 'p', label: 'p-value', get: r => asP(r.p, 4) },
            { key: 'n', label: 'Sample Size', get: r => r.N ?? r.original_sample_size ?? '' },
            { key: 'nsnp', label: 'Number of SNPs', get: r => r.original_nsnp ?? '' },
            { key: 'author', label: 'Author', get: r => r.author ?? '' },
            { key: 'year', label: 'Year', get: r => r.year ?? '' },
            { key: 'gwas_id', label: 'GWAS ID', get: r => r.gwas_id ?? '' },
            { key: 'ancestry', label: 'Ancestry', get: r => r.ancestry ?? '' }, //TODO
        ];

        //converts number to fixed digits or empty string
        function asNum(v, digits) {
            return (v != null && isFinite(v)) ? Number(v).toFixed(digits) : '';
        }

        //converts p-value to string with fixed digits or exponential notation
        function asP(p) {
            return (p != null && isFinite(p)) ? (p < 0.001 ? p.toExponential(2) : Number(p).toFixed(4)) : '';
        }

        //load results as JSON and normalize
        async function loadResults() {
            try {
                const url = 'assets/full_MA_results_fish2611.json'; //todo: make universal
                const res = await fetch(url, { cache: 'no-store' }); //always download the newest file
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                RES = await res.json();

                // Example:
                //     "SNP": "rs10061973",
                //     "effect_allele": "T",
                //     "non_effect_allele": "G",
                //     "sub_trait": "Oily fish intake",
                //     "chr": null,
                //     "position": null,
                //     "MAF": null,
                //     "Beta": null,
                //     "Std_Error": null,
                //     "OR": null,
                //     "CI_low": null,
                //     "CI_high": null,
                //     "p_value": null,
                //     "original_sample_size": 460443,
                //     "original_nsnp": 9851867,
                //     "author": "Ben Elsworth",
                //     "year": 2018,
                //     "gwas_id": "ukb-b-2209"

                const table = (Array.isArray(RES) && RES) || [];
                console.log('Loaded JSON keys:', Array.isArray(RES) ? ['<array>'] : Object.keys(RES));
                console.log('Primary table length:', table.length);
                if (!Array.isArray(table) || table.length === 0) {
                    console.warn('No rows found in results/top-level array.');
                }

                // ---- normalize into RAW ----
                //if data looks different/different files etc.
                RAW = table.map(d => {
                    const p = d.p_value ?? d.p;
                    const chr = d.chr;
                    const pos = d.position ?? d.pos;
                    return {
                        SNP: d.SNP ?? d.rsid ?? null,
                        effect_allele: d.effect_allele ?? d.A1 ?? null,
                        non_effect_allele: d.non_effect_allele ?? d.A2 ?? null,
                        trait: d.trait ?? null,
                        subtrait: d.sub_trait ?? null,
                        chr: chr != null ? String(chr) : '',
                        position: Number(pos),
                        MAF: (d.MAF != null ? Number(d.MAF) : (d.maf != null ? Number(d.maf) : null)),
                        Beta: (d.Beta != null ? Number(d.Beta) : (d.beta != null ? Number(d.beta) : null)),
                        Std_Error: (d.Std_Error != null ? Number(d.Std_Error) : (d.SE ?? d.se ?? d.std_error ?? null)),
                        OR: (d.OR != null ? Number(d.OR) : null),
                        p: Number(p),
                        original_sample_size: d.N ?? d.original_sample_size ?? null,
                        original_nsnp: d.original_nsnp ?? d.Nsnp ?? null,
                        posCum: Number.isFinite(d.pos_cum) ? Number(d.pos_cum) : null,
                        neglog: Number.isFinite(d.neglog10p) ? Number(d.neglog10p) : null,
                        author: d.author ?? null,
                        year: d.year ?? null,
                        gwas_id: d.gwas_id ?? null,
                        ancestry: d.ancestry ?? null,
                    };
                }).filter(r => r.chr && Number.isFinite(r.position) && Number.isFinite(r.p));

                console.log('Usable rows after normalization:', RAW.length);
                if (!RAW.length) throw new Error('No usable rows (missing chr/position/p).');

                // --helpers if needed ----
                if (RAW.some(r => r.posCum == null)) {
                    const chrOrder = Array.from(new Set(RAW.map(r => r.chr))).sort(naturalChrSort);
                    const maxPerChr = new Map(chrOrder.map(c => [c, Math.max(...RAW.filter(r => r.chr === c).map(r => r.position))]));
                    let offset = 0;
                    const chrOffset = new Map();
                    chrOrder.forEach(c => { chrOffset.set(c, offset); offset += maxPerChr.get(c) || 0; });
                    RAW.forEach(r => { if (r.posCum == null) r.posCum = (chrOffset.get(r.chr) || 0) + r.position; });
                }
                if (RAW.some(r => r.neglog == null)) {
                    RAW.forEach(r => { if (r.neglog == null && r.p > 0 && r.p <= 1) r.neglog = -Math.log10(r.p); });
                }

                // ---- fallback stats if missing ----
                if (!RES.stats) {
                    const pVals = RAW.map(r => r.p).filter(Number.isFinite);
                    const mafVals = RAW.map(r => r.MAF).filter(Number.isFinite).sort((a, b) => a - b);
                    const medMAF = mafVals.length
                        ? (mafVals.length % 2 ? mafVals[(mafVals.length - 1) / 2]
                            : (mafVals[mafVals.length / 2 - 1] + mafVals[mafVals.length / 2]) / 2)
                        : null;
                    const medAbsEffect = (() => {
                        const absEffects = RAW.map(r => {
                            const v = r.Beta != null ? Math.abs(r.Beta) : (r.OR != null ? Math.abs(Math.log(r.OR)) : null);
                            return (v != null && isFinite(v)) ? v : null;
                        }).filter(Number.isFinite).sort((a, b) => a - b);
                        if (!absEffects.length) return null;
                        return (absEffects.length % 2
                            ? absEffects[(absEffects.length - 1) / 2]
                            : (absEffects[absEffects.length / 2 - 1] + absEffects[absEffects.length / 2]) / 2);
                    })();
                    RES.stats = {
                        n_snps: RAW.length,
                        min_p: pVals.length ? Math.min(...pVals) : null,
                        median_maf: medMAF,
                        median_abs_effect: medAbsEffect
                    };
                }
                //init table columns
                TABLE.cols = ALL_COLS;
                TABLE.visibleCols = new Set(ALL_COLS.map(c => c.key));
                buildColumnPicker();

                //build filters + render
                buildFilters();
                applyFilters();

                renderAllPlots();

            } catch (error) {
                console.error('Failed to load/parse results JSON:', error);
                ['manhattan-plot', 'qq-plot', 'maf-plot', 'effect-plot', 'pval-top10-plot'].forEach(id => {
                    const plot = document.getElementById(id);
                    if (plot) plot.innerHTML = '<div class="p-4 text-red-800">Failed to load data.</div>';
                });
                const tb = document.getElementById('table-body');
                if (tb) tb.innerHTML = '<tr><td class = "p-3 text-red-800">Failed to load (table) data.</td></tr>';
            }
        }

        function renderAllPlots() {
            renderStats();
            renderManhattan();
            // renderQQ(); renderMAF(); renderEffects(); renderPvalTop10();
        }

        // get all info from the rows that were selected in the filters earlier
        function computeStatsFromFilters(rows) {
            const n_snps = rows.length;

            //min pvalue
            const pVals = rows.map(r => r.p).filter(Number.isFinite);
            const min_p = pVals.length ? Math.min(...pVals) : null;

            // median MAF
            const mafVals = rows
                .map(r => r.MAF)
                .filter(Number.isFinite)
                .sort((a, b) => a - b);

            let median_maf = null;
            if (mafVals.length) {
                const mid = Math.floor(mafVals.length / 2);
                median_maf = (mafVals.length % 2)
                    ? mafVals[mid]
                    : (mafVals[mid - 1] + mafVals[mid]) / 2;
            }

            // median absolute effect (|Beta| or |log(OR)|)
            const absEffects = rows
                .map(r => {
                    const v = r.Beta != null
                        ? Math.abs(r.Beta)
                        : (r.OR != null ? Math.abs(Math.log(r.OR)) : null);
                    return (v != null && isFinite(v)) ? v : null;
                })
                .filter(Number.isFinite)
                .sort((a, b) => a - b);

            let median_abs_effect = null;
            if (absEffects.length) {
                const mid = Math.floor(absEffects.length / 2);
                median_abs_effect = (absEffects.length % 2)
                    ? absEffects[mid]
                    : (absEffects[mid - 1] + absEffects[mid]) / 2;
            }

            return {
                n_snps,
                min_p,
                median_maf,
                median_abs_effect,
            };
        }

        function renderStats() {
            const wrap = document.getElementById('statsCards');
            if (!wrap) return;
            // Use filtered rows if available, otherwise all rows like before
            const rows = (TABLE.filtered && TABLE.filtered.length)
                ? TABLE.filtered
                : RAW;
            const s = computeStatsFromFilters(rows);
            const items = [
                {   key: 'n_snps',
                    label: 'SNPs',
                    value: s.n_snps ?? RAW.length ?? 0,
                    help: 'Number of SNP rows in the current selection (after all filters and p-value threshold).'
                },
                {   key: 'min_p',
                    label: 'Min p',
                    value: (s.min_p != null && isFinite(s.min_p)) ? Number(s.min_p).toExponential(2) : '—',
                    help: 'Minimum p-value in the current selection (after all filters and p-value threshold).'
                },
                {   key: 'median_maf',
                    label: 'Median MAF',
                    value: (s.median_maf != null) ? Number(s.median_maf).toFixed(3) : '—',
                    help: 'Median minor allele frequency (MAF) in the current selection (after all filters and p-value threshold).'
                },
                {   key: 'median_abs_effect',
                    label: 'Median absolute effect',
                    value: (s.median_abs_effect != null) ? Number(s.median_abs_effect).toFixed(4) : '—',
                    help: 'Median absolute effect size (|Beta| or |log(OR)|) in the current selection (after all filters and p-value threshold).'
                }
            ];
            wrap.innerHTML = items.map(i => `
        <div class="bg-white/70 backdrop-blur rounded-lg p-2 shadow-sm border border-gray-300 text-center">
            <div class="text-lg font-semibold text-[#004a6f]">${i.value}</div>
            <div class="text-sm text-gray-700 mt-0.5 flex items-center justify-center gap-1">
                <span>${i.label}</span>
                <button
                    type="button"
                    class="w-4 h-4 flex items-center justify-center rounded-full border border-gray-400 text-[10px] leading-none text-gray-600 hover:bg-gray-100"
                    title="${i.help}"
                >
                    i
                </button>
            </div>
        </div>
    `).join('');
        }

        //TODO: change and render stats whenever filters are changed


        function renderManhattan() {
            const plotDiv = document.getElementById('manhattan-plot');
            if (!plotDiv) return;
            if (!RAW.length) { plotDiv.innerHTML = '<div class="p-4">No SNP rows found.</div>'; return; }

            const byChr = new Map();
            RAW.forEach(d => { (byChr.get(d.chr) || byChr.set(d.chr, []).get(d.chr)).push(d); });

            const traces = Array.from(byChr.keys()).sort(naturalChrSort).map((chr, i) => {
                const arr = byChr.get(chr).slice().sort((a, b) => a.posCum - b.posCum);
                return {
                    x: arr.map(d => d.posCum),
                    y: arr.map(d => d.neglog),
                    text: arr.map(d => `${d.SNP ?? ''}<br>chr ${d.chr}:${d.position}<br>p=${d.p}`),
                    hovertemplate: '%{text}<extra></extra>',
                    mode: 'markers',
                    type: 'scattergl',
                    name: `chr ${chr}`,
                    marker: { size: 5, opacity: 0.8 }
                };
            });

            const maxX = Math.max(...RAW.map(d => d.posCum));
            const layout = {
                height: 380,
                margin: { t: 20, r: 10, b: 50, l: 55 },
                xaxis: { title: 'Genomic position (cumulative)', range: [0, maxX] },
                yaxis: { title: '-log10(p)' },
                hovermode: 'closest',
                plot_bgcolor: 'rgba(255,255,255,0)',
                paper_bgcolor: 'rgba(255,255,255,0)',
                legend: { orientation: 'h', y: -0.2 }
            };

            Plotly.newPlot(plotDiv, traces, layout, { responsive: true, displayModeBar: true });
        }

        function naturalChrSort(a, b) {
            const toKey = s => {
                s = String(s).toUpperCase();
                if (s === 'X') return 23;
                if (s === 'Y') return 24;
                if (s === 'MT' || s === 'M') return 25;
                const n = parseInt(s, 10);
                return isNaN(n) ? 26 : n;
            };
            return toKey(a) - toKey(b);
        }

        //filters ? table:
        function uniq(list) { return Array.from(new Set(list.filter(Boolean))).sort((a, b) => String(a).localeCompare(String(b))); }

        function buildFilters() {
            const fx = document.getElementById('f-trait');
            const fs = document.getElementById('f-subtrait');
            const fauth = document.getElementById('f-author');
            const fy = document.getElementById('f-year');
            const fa = document.getElementById('f-ancestry');

            // TODO: check names in file
            const traits = uniq(RAW.map(r => r.trait ?? r.trait_group));
            const subtraits = uniq(RAW.map(r => r.subtrait ?? r.trait));
            const authors = uniq(RAW.map(r => r.author ?? r.study));
            const years = uniq(RAW.map(r => r.year)).sort((a, b) => Number(a) - Number(b));
            const ancestries = uniq(RAW.map(r => r.ancestry));

            function fill(sel, items, label) {
                sel.innerHTML = `<option value="">All ${label}</option>` + items.map(v => `<option>${escapeHtml(v)}</option>`).join('');
                sel.addEventListener('change', () => { TABLE.page = 1; applyFilters(); });
            }

            fill(fx, traits, 'traits');
            fill(fs, subtraits, 'subtraits');
            fill(fauth, authors, 'authors');
            fill(fy, years, 'years');
            fill(fa, ancestries, 'ancestries');
            if (!ancestries.length) { fa.disabled = true; fa.title = 'No ancestry data available'; }

            //pvalue buttons
            document.querySelectorAll('.qbtn').forEach(btn => btn.addEventListener('click', () => {
                document.getElementById('f-pval').value = btn.dataset.p;
                TABLE.page = 1; applyFilters();
            }));

            document.getElementById('f-pval').addEventListener('input', () => { TABLE.page = 1; applyFilters(); });

            document.getElementById('prev-page').addEventListener('click', () => { if (TABLE.page > 1) { TABLE.page--; renderTable(); } });
            document.getElementById('next-page').addEventListener('click', () => { const maxPage = Math.max(1, Math.ceil(TABLE.filtered.length / TABLE.perPage)); if (TABLE.page < maxPage) { TABLE.page++; renderTable(); } });

            document.getElementById('download-btn').addEventListener('click', downloadCSV);

            // Column picker toggle
            document.getElementById('colpick-toggle').addEventListener('click', () => {
                document.getElementById('colpick').classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                const p = document.getElementById('colpick');
                const b = document.getElementById('colpick-toggle');
                if (!p.contains(e.target) && !b.contains(e.target)) p.classList.add('hidden');
            });
        }

        function applyFilters() {
            const fx = document.getElementById('f-trait').value;
            const fs = document.getElementById('f-subtrait').value;
            const fauth = document.getElementById('f-author').value;
            const fy = document.getElementById('f-year').value;
            const fa = document.getElementById('f-ancestry').value;
            const pmaxRaw = document.getElementById('f-pval').value.trim();
            const pmax = parseSci(pmaxRaw);

            TABLE.filtered = RAW.filter(r => {
                if (fx && (r.trait ?? r.trait_group) !== fx) return false;
                if (fs && (r.subtrait ?? r.sub_trait) !== fs) return false;
                if (fauth && (r.author ?? r.study) !== fauth) return false;
                if (fy && String(r.year) !== fy) return false;
                if (fa && (r.ancestry) !== fa) return false;
                if (pmax != null && isFinite(pmax) && r.p > pmax) return false;
                return true;
            });
            TABLE.page = 1; //go to first page again after filtering
            renderTable();
            renderStats(); //update stats if filters are changes
        }

        function buildColumnPicker() {
            const host = document.getElementById('colpick');
            host.innerHTML = TABLE.cols.map(col => `
        <label class="flex items-center gap-2 px-1 py-1 text-sm">
          <input type="checkbox" data-col="${col.key}" ${TABLE.visibleCols.has(col.key) ? 'checked' : ''} />
          <span>${col.label}</span>
        </label>
      `).join('');
            host.querySelectorAll('input[type="checkbox"]').forEach(chk => {
                chk.addEventListener('change', (e) => {
                    const key = e.target.dataset.col;
                    if (e.target.checked) TABLE.visibleCols.add(key); else TABLE.visibleCols.delete(key);
                    renderTable();
                });
            });
        }

        function renderTable() {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');
            const cols = TABLE.cols.filter(c => TABLE.visibleCols.has(c.key));
            head.innerHTML = cols.map(c => `<th class="text-left font-semibold px-3 py-2 whitespace-nowrap">${c.label}</th>`).join('');

            const start = (TABLE.page - 1) * TABLE.perPage;
            const rows = TABLE.filtered.slice(start, start + TABLE.perPage);
            body.innerHTML = rows.map(r => `
        <tr class="odd:bg-white even:bg-gray-50/70">
          ${cols.map(c => `<td class="px-3 py-2 whitespace-nowrap">${escapeHtml(String(c.get(r) ?? ''))}</td>`).join('')}
        </tr>
      `).join('');

            const maxPage = Math.max(1, Math.ceil(TABLE.filtered.length / TABLE.perPage));
            document.getElementById('page-label').textContent = `Page ${TABLE.page} / ${maxPage}`;
            document.getElementById('table-status').textContent = `${TABLE.filtered.length.toLocaleString()} rows` + (TABLE.filtered.length !== RAW.length ? ' (filtered)' : '');
        }

        function downloadCSV() {
            const cols = TABLE.cols.filter(c => TABLE.visibleCols.has(c.key));
            const header = cols.map(c => csvEscape(c.label)).join(',');
            const lines = TABLE.filtered.map(r => cols.map(c => csvEscape(c.get(r))).join(','));
            const csv = [header, ...lines].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'summary_statistics.csv';
            document.body.appendChild(a); a.click(); a.remove();
        }

        function csvEscape(v) {
            if (v == null) return '';
            const s = String(v);
            if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
            return s;
        }

        function parseSci(txt) {
            if (!txt) return null;
            const t = String(txt).trim();
            if (t.toLowerCase() === 'all') return 1;
            const n = Number(t);
            if (!isNaN(n)) return n;
            // accept like 5e-8 with spaces
            const m = t.match(/^([0-9]*\.?[0-9]+)\s*e\s*([+-]?\d+)$/i);
            if (m) return Number(m[1]) * Math.pow(10, Number(m[2]));
            return null;
        }

        function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c])); }

        document.addEventListener('DOMContentLoaded', loadResults);

        const path = location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('a[href]').forEach(a => {
            if (a.getAttribute('href') === path) {
                a.classList.add('ring-2', 'ring-[#004a6f]', 'border-[#004a6f]');
            }
        });

        // Mobile nav toggle
        const mobileNav = document.getElementById('mobile-nav');
        const openBtn = document.getElementById('mobile-nav-toggle');
        const closeBtn = document.getElementById('mobile-nav-close');

        if (mobileNav && openBtn && closeBtn) {
            function openNav() {
                mobileNav.classList.remove('hidden');
            }

            function closeNav() {
                mobileNav.classList.add('hidden');
            }

            openBtn.addEventListener('click', openNav);
            closeBtn.addEventListener('click', closeNav);

            // close when clicking outside the drawer
            mobileNav.addEventListener('click', (e) => {
                if (e.target === mobileNav) {
                    closeNav();
                }
            });

            // close after clicking a link in mobile menu
            mobileNav.querySelectorAll('a[href]').forEach(a => {
                a.addEventListener('click', closeNav);
            });
        }

    </script>

</body>

</html>
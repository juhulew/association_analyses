<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Summary Association Statistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <!-- code for styles for all pages -->
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <!-- sametop bar for all pages -->
    <header class="fixed inset-x-0 top-0 z-50 bg-[#004a6f]">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 h-12 flex items-center justify-between">
            <img src="ukhd_logo.jpg" alt="logo" class="h-8 w-auto bg-white/70 backdrop-blur shadow-sm select-none" />
            <span
                class="rounded-xl bg-white/70 backdrop-blur px-3 py-1 text-xs font-medium shadow-sm select-none text-center">
                ENG
            </span>
        </div>
    </header>

    <!-- Page Content -->
    <main class="layer max-w-8xl mx-auto px-16 lg:px-12 min-h-screen flex flex-col pt-16">
        <div class="grid grid-cols-12 gap-6 mt-10 flex-grow">
            <!-- nav Sidebar navigation -->
            <nav class="col-span-3 sm:col-span-2 md:col-span-1 mt-6">
                <ul class="space-y-3">
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="index.html">Home</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="data.html">Data</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="sources.html">Sources</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="contact.html">Contact</a></li>
                    <li><a class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
                            href="about.html">About</a></li>
                </ul>
            </nav>

            <!--Pages: -->
            <section
                class="col-span-8 sm:col-span-9 md:col-span-10 rounded-xl bg-white/40 backdrop-blur border border-gray-500 mt-6 mx-6 shadow-sm">
                <h2 class="text-4xl font-medium leading-tight text-[#004a6f] drop-shadow px-6">Trying out my data:</h2>

                <div class="p-6 grid gap-6">
                    <div id="statsCards" class="grid gap-4 sm:grid-cols-3"></div>
                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">Manhattan</h3>
                        <div id="manhattan-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                        </div>
                    </div>

                    <div class="grid gap-6 sm:grid-cols-2">
                        <div>
                            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">QQ plot</h3>
                            <div id="" qq-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">MAF distribution</h3>
                            <div id="maf-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">effect size (log OR with 95% CI)</h3>
                        <div id="effect-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-[#004a6f] mb-2">P-value top 10</h3>
                        <div id="pval-top10-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur">
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <footer class="mt-auto text-center text-xs text-gray-800/80 py-4">
            Â© <span id="year"></span> Summary Association Statistics
        </footer>
    </main>


    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        //load data

        let RES = null;

        async function loadResults() {
            try {
                const res = await fetch('assets/ma_rsults_fish1011.json', { cache: 'no-store' });
                if (!res.ok) throw new Error('HTTP ${res.status}');
                RES = await res.json();
                renderAllPlots();
            } catch (error) {
                console.error('Failed to load ma_results_fish1011.json:', error);
                ['manhattan-plot', 'qq-plot', 'maf-plot', 'effect-plot', 'pval-top10-plot'].forEach(id => {
                    const plot = document.getElementById(id);
                    if (plot) plot.innerHTML = '<div class="p-4 text-red-800">Failed to load data.</div>';
                });
            }
        }

        function renderAllPlots() {
            renderStats();
            renderManhattan();
            renderQQ();
            renderMAF();
            renderEffects();
            renderPvalTop10();
        }

        //small ui cards
        function renderStats() {
            const wrap = document.getElementById('statsCards');
            if (!wrap || !RES?.stats) return;
            const items = [
                { label: 'SNPs', value: RES.stats.n_snps },
                { label: 'Min p', value: Number(RES.stats.min_p).toExponential(2) },
                { label: 'Median MAF', value: RES.stats.median_maf?.toFixed(3) }
            ];
            wrap.innerHTML = items.map(i => `
                <div class="bg-white/70 backdrop-blur rounded-xl p-4 shadow-sm border border-gray-300 text-center">
                    <div class="text-2xl font-semibold text-[#004a6f]">${i.value ?? '-'}</div>
                    <div class="text-sm text-gray-700 mt-1">${i.label}</div>
                </div>
            `).join('');
        }

        function renderManhattan() {
            const plotDiv = document.getElementById('manhattan-plot');
            if (!plotDiv || !RES?.manhatten) return;

            const data = RES.manhatten;
            const chromosomes = {};
            data.forEach(d => {
                const chr = String(d.chr);
                (chromosomes[chr] ||= []).push(d);
            });
            const traces = Object.keys(chromosomes).sort((a, b) => naturalChrSort(a, b)).map((chr, i) => {
                const arr = chromosomes[chr].sort((a, b) => (a.pos_cum ?? a.position) - (b.pos_cum ?? b.position));
                return {
                    x: arr.map(d => d.pos_cum ?? d.position),
                    y: arr.map(d => d.neglog10p),
                    mode: 'markers',
                    type: 'scattergl',
                    name: `Chr ${chr}`,
                    marker: {
                        color: i % 2 === 0 ? '#004a6f' : '#007bb3',
                        size: 4,
                        opacity: 0.7
                    },
                    text: arr.map(d => `chr: ${d.chr}, pos: ${d.position}, pval: ${d.pval}`)
                };
            });

            const maxX = Math.max(...RES.results.map(d => d.pos_cum ?? d.position));
            const layout = {
                height: 380,
                margin: { t: 20, r: 10, b: 50, l: 55 },
                xaxis: { title: 'Genomic position', range: [0, maxX] },
                yaxis: { title: '-log10(p)' },
                hovermode: 'closest',
                plot_bgcolor: 'rgba(255,255,255,0)',
                paper_bgcolor: 'rgba(255,255,255,0)',
                legend: { orientation: 'h', y: -0.2 }
            };

            Plotly.newPlot(el, traces, layout, { responsive: true, displayModeBar: true });
        }

        function naturalChrSort(a, b) {
            //handle numeric x, y, mt ordering
            const toKey = x => {
                const s = String(x).toUpperCase();
                if (s === 'X') return 23;
                if (s === 'Y') return 24;
                if (s === 'MT' || s === 'M') return 25;
                const n = parseInt(s, 10);
                return isNaN(n) ? 26 : n;
            };
            return toKey(a) - toKey(b);
        }

        function renderQQ() {

        }

        function renderMAF() {

        }

        function renderEffects() {

        }

        function renderPvalTop10() {

        }

        loadResults();

        /*
        let raw = [];
        async function loadData() {
            try {
                const res = await fetch('assets/data.json');
                if (!res.ok) throw new Error('HTTP ${res.status}');
                raw = await res.json();

                //populate group select
                const groups = Array.from(new Set(raw.map(d => d.group))).sort();
                const sel = document.getElementById('groupSelect');
                groups.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = g;
                    sel.appendChild(option);
                });
                draw();
            } catch (error) {
                console.error('Failed to load data.json:', error);
                const plot = document.getElementById('plot');
                if (plot) plot.innerHTML = '<div class="text-red-800">Failed to load data.</div>';
            }
        }

        function getSubset() {
            const g = document.getElementById('groupSelect').value;
            return g === 'ALL' ? raw : raw.filter(d => d.group === g);
        }

        function draw() {
            const data = getSubset();
            const xVar = document.getElementById('xSelect').value;
            const yVar = document.getElementById('ySelect').value;

            const trace = {
                x: data.map(d => +d[xVar]),
                y: data.map(d => +d[yVar]),
                mode: 'markers',
                type: 'scatter',
                marker: { size: 8, color: '#004a6f', opacity: 0.7 },
                text: data.map(d => `id: ${d.id}, group: ${d.group}`)
            };
            const layout = {
                margin: { t: 20, r: 20, b: 40, l: 50 },
                xaxis: { title: xVar },
                yaxis: { title: yVar },
                hovermode: 'closest',
                height: 400,
                plot_bgcolor: 'rgba(255,255,255,0)',
                paper_bgcolor: 'rgba(255,255,255,0)'
            };

            Plotly.newPlot("plot", [trace], layout, { displayModeBar: true, responsive: true });
        }

        //redraw when control kthings change
        ['groupSelect', 'xSelect', 'ySelect'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', draw);
        });

        loadData();
*/

        // JS to highlight current page
        const path = location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('a[href]').forEach(a => {
            if (a.getAttribute('href') === path) {
                a.classList.add('ring-2', 'ring-[#004a6f]', 'border-[#004a6f]');
            }
        });

    </script>
</body>

</html>
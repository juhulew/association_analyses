<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Summary Association Statistics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <!-- code for styles for all pages -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- sametop bar for all pages -->
  <header class="fixed inset-x-0 top-0 z-50 bg-[#004a6f]">
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 h-12 flex items-center justify-between">
      <img src="ukhd_logo.jpg" alt="logo" class="h-8 w-auto bg-white/70 backdrop-blur shadow-sm select-none" />
      <span
        class="rounded-xl bg-white/70 backdrop-blur px-3 py-1 text-xs font-medium shadow-sm select-none text-center">
        ENG
      </span>
    </div>
  </header>

  <!-- Page Content -->
  <main class="layer max-w-8xl mx-auto px-16 lg:px-12 min-h-screen flex flex-col pt-16">
    <div class="grid grid-cols-12 gap-6 mt-10 flex-grow">
      <!-- nav Sidebar navigation -->
      <nav class="col-span-3 sm:col-span-2 md:col-span-1 mt-6">
        <ul class="space-y-3">
          <li><a
              class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
              href="index.html">Home</a></li>
          <li><a
              class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
              href="data.html">Data</a></li>
          <li><a
              class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
              href="sources.html">Sources</a></li>
          <li><a
              class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
              href="contact.html">Contact</a></li>
          <li><a
              class="btn-nav block w-full text-left px-4 py-2 rounded-xl border border-gray-500 bg-white/70 backdrop-blur hover:bg-white/90 transition shadow-sm"
              href="about.html">About</a></li>
        </ul>
      </nav>

      <!--Pages: -->
      <section
        class="col-span-8 sm:col-span-9 md:col-span-10 rounded-xl bg-white/40 backdrop-blur border border-gray-500 mt-6 mx-6 shadow-sm">
        <h2 class="text-4xl font-medium leading-tight text-[#004a6f] drop-shadow px-6">Trying out my data:</h2>

        <div class="p-6 grid gap-6">
          <div id="statsCards" class="grid gap-4 sm:grid-cols-3"></div>

          <!-- NEW: Summary statistics browser (table + filters + download) -->
          <div class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur p-4">
            <div class="flex flex-wrap items-end gap-3">
              <div>
                <label class="block text-xs text-gray-700 mb-1">Exposure / trait</label>
                <select id="f-exposure" class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
              </div>
              <div>
                <label class="block text-xs text-gray-700 mb-1">Specific trait / subtrait</label>
                <select id="f-subtrait" class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
              </div>
              <div>
                <label class="block text-xs text-gray-700 mb-1">Publication</label>
                <select id="f-publication" class="px-3 py-2 border rounded-lg bg-white/80 min-w-[12rem]"></select>
              </div>
              <div>
                <label class="block text-xs text-gray-700 mb-1">Ancestry</label>
                <select id="f-ancestry" class="px-3 py-2 border rounded-lg bg-white/80 min-w-[10rem]"></select>
              </div>
              <div>
                <label class="block text-xs text-gray-700 mb-1">Max p-value</label>
                <div class="flex items-center gap-2">
                  <input id="f-pval" type="text" value="1" class="px-3 py-2 border rounded-lg bg-white/80 w-28"
                    placeholder="e.g. 5e-8" />
                  <div class="flex gap-1">
                    <button data-p="5e-8" class="qbtn px-2 py-1 text-xs border rounded-lg">5e-8</button>
                    <button data-p="1e-5" class="qbtn px-2 py-1 text-xs border rounded-lg">1e-5</button>
                    <button data-p="0.05" class="qbtn px-2 py-1 text-xs border rounded-lg">0.05</button>
                    <button data-p="1" class="qbtn px-2 py-1 text-xs border rounded-lg">All</button>
                  </div>
                </div>
              </div>
              <div class="ml-auto flex items-end gap-2">
                <!-- Column picker -->
                <div class="relative">
                  <button id="colpick-toggle" class="px-3 py-2 border rounded-lg bg-white/80">Select columns</button>
                  <div id="colpick"
                    class="absolute right-0 mt-2 w-64 bg-white border rounded-xl shadow-lg p-3 hidden max-h-64 overflow-auto">
                  </div>
                </div>
                <button id="download-btn" class="px-3 py-2 rounded-lg bg-[#004a6f] text-white shadow-sm">Download
                  CSV</button>
              </div>
            </div>

            <!-- Table -->
            <div class="mt-4 border rounded-xl overflow-hidden">
              <div class="max-h-[420px] overflow-auto">
                <table class="min-w-full text-sm" id="stats-table">
                  <thead class="sticky top-0 bg-white/90 backdrop-blur">
                    <tr id="table-head"></tr>
                  </thead>
                  <tbody id="table-body" class="divide-y"></tbody>
                </table>
              </div>
              <div class="flex justify-between items-center px-3 py-2 text-xs">
                <div id="table-status" class="text-gray-600"></div>
                <div class="flex items-center gap-2">
                  <button id="prev-page" class="px-2 py-1 border rounded-lg">Prev</button>
                  <span id="page-label"></span>
                  <button id="next-page" class="px-2 py-1 border rounded-lg">Next</button>
                </div>
              </div>
            </div>
          </div>

          <div>
            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">Manhattan</h3>
            <div id="manhattan-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
          </div>

          <div class="grid gap-6 sm:grid-cols-2">
            <div>
              <h3 class="text-xl font-semibold text-[#004a6f] mb-2">QQ plot</h3>
              <div id="qq-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-[#004a6f] mb-2">MAF distribution</h3>
              <div id="maf-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
            </div>
          </div>

          <div>
            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">effect size (log OR with 95% CI)</h3>
            <div id="effect-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
          </div>

          <div>
            <h3 class="text-xl font-semibold text-[#004a6f] mb-2">P-value top 10</h3>
            <div id="pval-top10-plot" class="rounded-xl border border-gray-300 bg-white/70 backdrop-blur"></div>
          </div>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <footer class="mt-auto text-center text-xs text-gray-800/80 py-4">
      © <span id="year"></span> Summary Association Statistics
    </footer>
  </main>


  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    let RES = null;
    let RAW = []; // normalized SNP rows

    // ====== New: table state ======
    const TABLE = {
      page: 1,
      perPage: 25,
      cols: [],
      visibleCols: new Set(),
      filtered: [],
    };

    // Column definitions (key, label, getter)
    const ALL_COLS = [
      { key: 'SNP', label: 'SNP', get: r => r.SNP ?? '' },
      { key: 'exposure', label: 'Exposure / trait', get: r => r.exposure ?? r.trait_group ?? r.trait ?? '' },
      { key: 'subtrait', label: 'Specific trait / subtrait', get: r => r.subtrait ?? r.sub_trait ?? '' },
      { key: 'effect_allele', label: 'Effect allele', get: r => r.effect_allele ?? r.A1 ?? '' },
      { key: 'minor_allele', label: 'Minor allele', get: r => r.minor_allele ?? '' },
      { key: 'chr', label: 'Chr', get: r => r.chr ?? '' },
      { key: 'position', label: 'Position', get: r => r.position ?? '' },
      { key: 'GWAS_ID', label: 'GWAS ID', get: r => r.gwas_id ?? '' },
      { key: 'author', label: 'Author', get: r => r.author ?? '' },
      { key: 'year', label: 'Year', get: r => r.year ?? '' },
      { key: 'o_sample_size', label: 'Original Sample Size', get: r => r.original_sample_size ?? '' },
      { key: 'o_ancestry', label: 'Original Ancestry', get: r => r.original_ancestry ?? '' },
      { key: 'o_maf', label: 'MAF', get: r => asNum(r.original_MAF, 3) },
      { key: 'o_beta', label: 'Beta', get: r => asNum(r.original_beta, 4) },
      { key: 'o_se', label: 'Original SE', get: r => asNum(r.original_sd, 4) },
      { key: 'o_pvalue', label: 'original p', get: r => asP(r.original_p) },
      { key: 'eu_sample_size', label: 'Eulat Sample Size', get: r => r.eulat_sample_size ?? '' },
      { key: 'eu_ancestry', label: 'Eulat Ancestry', get: r => r.eulat_ancestry ?? '' },
      { key: 'eu_maf', label: 'Eulat MAF', get: r => asNum(r.eulat_MAF, 3) },
      { key: 'eu_beta', label: 'Eulat Beta', get: r => asNum(r.eulat_beta, 4) },
      { key: 'eu_se', label: 'Eulat SE', get: r => asNum(r.eulat_sd, 4) },
      { key: 'eu_p', label: 'Eulat p', get: r => asP(r.eulat_p) },
    ];

    function asNum(v, d) { return (v != null && isFinite(v)) ? Number(v).toFixed(d) : ''; }
    function num(v) { return v != null && isFinite(v); }
    function asP(p) { return (p != null && isFinite(p)) ? (p < 0.001 ? p.toExponential(2) : Number(p).toFixed(4)) : ''; }
    function numberify(v) { if (v == null) return null; const n = Number(v); return Number.isFinite(n) ? n : null; }


    async function loadResults() {
      try {
        const path = 'assets/full_MA_results';   // base path
        const extension = '.json';
        const allRows = [];

        let index = 1;

        while (true) {
          const endNumber = String(index).padStart(2, '0');
          const url = `${path}${endNumber}${extension}`;

          console.log(`Trying to load: ${url}`);

          let res;
          try {
            res = await fetch(url, { cache: 'no-store' });
          } catch (err) {
            console.log(`Network error for ${url}, assuming no more files.`);
            break;
          }

          if (!res.ok) {
            console.log(`No more files found after index ${index - 1}. Stopping load. Status: ${res.status} `);
            break;
          }

          const json = await res.json();
          const table = Array.isArray(json) ? json : [];
          console.log(`Loaded from ${url}, raw rows: ${table.length}`);

          table.forEach(d => {
            const original_p = d.original_p;
            const eulat_p = d.eulat_p ?? d.eulat_p_value;;
            const original_p_n = numberify(d.original_p);
            const eulat_p_n = numberify(d.eulat_p ?? d.eulat_p_value); // <-- correct key
            const p_u = Number.isFinite(original_p_n) ? original_p_n : eulat_p_n;
            const chr = d.chr;
            const pos = d.position ?? d.pos;

            const num = v => (v == null ? null : (Number(v))); //easyer to read later
            const isNum = v => Number.isFinite(v);
            const row = {
              SNP: d.SNP ?? d.rsid ?? null,
              exposure: d.exposure ?? d.trait_group ?? null,
              subtrait: d.subtrait ?? d.trait ?? null,
              effect_allele: d.effect_allele ?? d.A1 ?? null,
              minor_allele: d.non_effect_allele ?? d.minor_allele ?? d.A2 ?? null,
              chr: chr != null ? String(chr) : '',
              position: Number(pos),

              gwas_id: d.GWAS_ID ?? d.gwas_id ?? null,
              author: d.author ?? null,
              year: d.year != null ? Number(d.year) : null,
              original_sample_size: d.original_sample_size ?? d.o_sample_size ?? null,
              original_ancestry: d.original_ancestry ?? d.o_ancestry ?? null,
              original_MAF: numberify(d.original_MAF ?? d.o_maf),
              original_beta: numberify(d.original_beta ?? d.o_beta),
              original_sd: numberify(d.original_sd ?? d.o_se),
              original_p: original_p_n,

              eulat_sample_size: d.eulat_sample_size ?? d.eu_sample_size ?? null,
              eulat_ancestry: d.eulat_ancestry ?? d.eu_ancestry ?? null,
              eulat_MAF: numberify(d.eulat_MAF ?? d.eu_maf),
              eulat_beta: numberify(d.eulat_beta ?? d.eu_beta),
              eulat_sd: numberify(d.eulat_sd ?? d.eulat_std_error ?? d.eu_se),
              eulat_p: eulat_p_n,

              // convenience fields used by filters/stats
              publication: d.publication ?? (d.author || d.year ? `${d.author ?? ''} ${d.year ?? ''}`.trim() : null),
              ancestry: d.original_ancestry ?? d.eulat_ancestry ?? null,
              MAF: Number.isFinite(num(d.original_MAF)) ? num(d.original_MAF) : num(d.eulat_MAF),
              p: p_u,

              posCum: d.posCum != null ? Number(d.posCum) : null, //precomputed
              neglog: d.neglog != null ? Number(d.neglog) : null, //precomputed
            };
            // keep only rows with valid chr, position and p
            allRows.push(row);
          });
          index++;
        }

        RAW = allRows;
        console.log('Total usable rows after loading all files:', RAW.length);

        if (!RAW.length) {
          throw new Error('No usable rows (missing chr/position/p) across all files.');
        }

        // helpers
        if (RAW.some(r => r.posCum == null)) {
          const chrOrder = Array.from(new Set(RAW.map(r => r.chr))).sort(naturalChrSort);
          const maxPerChr = new Map(chrOrder.map(c => [c, Math.max(...RAW.filter(r => r.chr === c).map(r => r.position))]));
          let offset = 0;
          const chrOffset = new Map();
          chrOrder.forEach(c => { chrOffset.set(c, offset); offset += maxPerChr.get(c) || 0; });
          RAW.forEach(r => { if (r.posCum == null) r.posCum = (chrOffset.get(r.chr) || 0) + r.position; });
        }
        if (RAW.some(r => r.neglog == null)) {
          RAW.forEach(r => {
            if (r.neglog == null && r.p > 0 && r.p <= 1) r.neglog = -Math.log10(r.p);
          });
        }

        if (!RES || typeof RES !== 'object') {
          RES = {};
        }

        // fallback stats
        if (!RES.stats) {
          const pVals = RAW.map(r => r.p).filter(Number.isFinite);
          const mafVals = RAW.map(r => r.MAF).filter(Number.isFinite).sort((a, b) => a - b);
          const medMAF = mafVals.length
            ? (mafVals.length % 2 ? mafVals[(mafVals.length - 1) / 2]
              : (mafVals[mafVals.length / 2 - 1] + mafVals[mafVals.length / 2]) / 2)
            : null;

          const absEffects = RAW.map(r => {
            const v = r.Beta != null
              ? Math.abs(r.Beta)
              : (r.OR != null ? Math.abs(Math.log(r.OR)) : null);
            return (v != null && isFinite(v)) ? v : null;
          }).filter(Number.isFinite).sort((a, b) => a - b);

          const medAbsEffect = absEffects.length
            ? (absEffects.length % 2
              ? absEffects[(absEffects.length - 1) / 2]
              : (absEffects[absEffects.length / 2 - 1] + absEffects[absEffects.length / 2]) / 2)
            : null;

          RES.stats = {
            n_snps: RAW.length,
            min_p: pVals.length ? Math.min(...pVals) : null,
            median_maf: medMAF,
            median_abs_effect: medAbsEffect
          };

        }

        // Init table columns (default visible)
        TABLE.cols = ALL_COLS;
        TABLE.visibleCols = new Set(ALL_COLS.map(c => c.key));
        buildColumnPicker();

        // Build filters & first render
        buildFilters();
        applyFilters();

        renderAllPlots();
      } catch (error) {
        console.error('Failed to load/parse results JSON:', error);
        ['manhattan-plot', 'qq-plot', 'maf-plot', 'effect-plot', 'pval-top10-plot'].forEach(id => {
          const plot = document.getElementById(id);
          if (plot) plot.innerHTML = '<div class="p-4 text-red-800">Failed to load data.</div>';
        });
        const tb = document.getElementById('table-body');
        if (tb) tb.innerHTML = '<tr><td class="p-3 text-red-800">Failed to load data.</td></tr>';
      }
    }

    function renderAllPlots() {
      renderStats();
      renderManhattan();
      // renderQQ(); renderMAF(); renderEffects(); renderPvalTop10();
    }

    function renderStats() {
      const wrap = document.getElementById('statsCards');
      if (!wrap) return;
      const s = RES?.stats || {};
      const items = [
        { label: 'SNPs', value: s.n_snps ?? RAW.length ?? 0 },
        { label: 'Min p', value: (s.min_p != null && isFinite(s.min_p)) ? Number(s.min_p).toExponential(2) : '—' },
        { label: 'Median MAF', value: (s.median_maf != null) ? Number(s.median_maf).toFixed(3) : '—' }
      ];
      wrap.innerHTML = items.map(i => `
    <div class="bg-white/70 backdrop-blur rounded-xl p-4 shadow-sm border border-gray-300 text-center">
      <div class="text-2xl font-semibold text-[#004a6f]">${i.value}</div>
      <div class="text-sm text-gray-700 mt-1">${i.label}</div>
    </div>
  `).join('');
    }

    function renderManhattan() {
      const plotDiv = document.getElementById('manhattan-plot');
      if (!plotDiv) return;
      if (!RAW.length) { plotDiv.innerHTML = '<div class="p-4">No SNP rows found.</div>'; return; }

      const byChr = new Map();
      RAW.forEach(d => { (byChr.get(d.chr) || byChr.set(d.chr, []).get(d.chr)).push(d); });

      const traces = Array.from(byChr.keys()).sort(naturalChrSort).map((chr, i) => {
        const arr = byChr.get(chr).slice().sort((a, b) => a.posCum - b.posCum);
        return {
          x: arr.map(d => d.posCum),
          y: arr.map(d => d.neglog),
          text: arr.map(d => `${d.SNP ?? ''}<br>chr ${d.chr}:${d.position}<br>p=${d.p}`),
          hovertemplate: '%{text}<extra></extra>',
          mode: 'markers',
          type: 'scattergl',
          name: `chr ${chr}`,
          marker: { size: 5, opacity: 0.8 }
        };
      });

      const maxX = Math.max(...RAW.map(d => d.posCum));
      const layout = {
        height: 380,
        margin: { t: 20, r: 10, b: 50, l: 55 },
        xaxis: { title: 'Genomic position (cumulative)', range: [0, maxX] },
        yaxis: { title: '-log10(p)' },
        hovermode: 'closest',
        plot_bgcolor: 'rgba(255,255,255,0)',
        paper_bgcolor: 'rgba(255,255,255,0)',
        legend: { orientation: 'h', y: -0.2 }
      };

      Plotly.newPlot(plotDiv, traces, layout, { responsive: true, displayModeBar: true });
    }

    function naturalChrSort(a, b) {
      const toKey = s => {
        s = String(s).toUpperCase();
        if (s === 'X') return 23;
        if (s === 'Y') return 24;
        if (s === 'MT' || s === 'M') return 25;
        const n = parseInt(s, 10);
        return isNaN(n) ? 26 : n;
      };
      return toKey(a) - toKey(b);
    }

    // ====== Filters & table ======
    function uniq(list) { return Array.from(new Set(list.filter(Boolean))).sort((a, b) => String(a).localeCompare(String(b))); }

    function buildFilters() {
      const fx = document.getElementById('f-exposure');
      const fs = document.getElementById('f-subtrait');
      const fp = document.getElementById('f-publication');
      const fa = document.getElementById('f-ancestry');

      const exposures = uniq(RAW.map(r => r.exposure ?? r.trait_group));
      const subtraits = uniq(RAW.map(r => r.subtrait ?? r.trait ?? r.sub_trait));
      const pubs = uniq(RAW.map(r => r.publication ?? r.study));
      const ancestries = uniq(RAW.map(r => r.ancestry));

      function fill(sel, items, label) {
        sel.innerHTML = `<option value="">All ${label}</option>` + items.map(v => `<option>${escapeHtml(v)}</option>`).join('');
        sel.addEventListener('change', () => { TABLE.page = 1; applyFilters(); });
      }

      fill(fx, exposures, 'exposures');
      fill(fs, subtraits, 'subtraits');
      fill(fp, pubs, 'publications');
      fill(fa, ancestries, 'ancestries');
      if (!ancestries.length) { fa.disabled = true; fa.title = 'No ancestry column in data (can be added later)'; }

      document.querySelectorAll('.qbtn').forEach(btn => btn.addEventListener('click', () => {
        document.getElementById('f-pval').value = btn.dataset.p;
        TABLE.page = 1; applyFilters();
      }));

      document.getElementById('f-pval').addEventListener('input', () => { TABLE.page = 1; applyFilters(); });

      document.getElementById('prev-page').addEventListener('click', () => { if (TABLE.page > 1) { TABLE.page--; renderTable(); } });
      document.getElementById('next-page').addEventListener('click', () => { const maxPage = Math.max(1, Math.ceil(TABLE.filtered.length / TABLE.perPage)); if (TABLE.page < maxPage) { TABLE.page++; renderTable(); } });

      document.getElementById('download-btn').addEventListener('click', downloadCSV);

      // Column picker toggle
      document.getElementById('colpick-toggle').addEventListener('click', () => {
        document.getElementById('colpick').classList.toggle('hidden');
      });
      document.addEventListener('click', (e) => {
        const p = document.getElementById('colpick');
        const b = document.getElementById('colpick-toggle');
        if (!p.contains(e.target) && !b.contains(e.target)) p.classList.add('hidden');
      });
    }

    function applyFilters() {
      const fx = document.getElementById('f-exposure').value;
      const fs = document.getElementById('f-subtrait').value;
      const fp = document.getElementById('f-publication').value;
      const fa = document.getElementById('f-ancestry').value;
      const pmaxRaw = document.getElementById('f-pval').value.trim();
      const pmax = parseSci(pmaxRaw);

      TABLE.filtered = RAW.filter(r => {
        if (fx && (r.exposure ?? r.trait_group) !== fx) return false;
        if (fs && (r.subtrait ?? r.trait) !== fs) return false;
        if (fp && (r.publication ?? r.study) !== fp) return false;
        if (fa && (r.ancestry) !== fa) return false;
        if (pmax != null && isFinite(pmax) && r.p > pmax) return false;
        return true;
      });

      renderTable();
    }

    function buildColumnPicker() {
      const host = document.getElementById('colpick');
      host.innerHTML = TABLE.cols.map(col => `
        <label class="flex items-center gap-2 px-1 py-1 text-sm">
          <input type="checkbox" data-col="${col.key}" ${TABLE.visibleCols.has(col.key) ? 'checked' : ''} />
          <span>${col.label}</span>
        </label>
      `).join('');
      host.querySelectorAll('input[type="checkbox"]').forEach(chk => {
        chk.addEventListener('change', (e) => {
          const key = e.target.dataset.col;
          if (e.target.checked) TABLE.visibleCols.add(key); else TABLE.visibleCols.delete(key);
          renderTable();
        });
      });
    }

    function renderTable() {
      const head = document.getElementById('table-head');
      const body = document.getElementById('table-body');
      const cols = TABLE.cols.filter(c => TABLE.visibleCols.has(c.key));
      head.innerHTML = cols.map(c => `<th class="text-left font-semibold px-3 py-2 whitespace-nowrap">${c.label}</th>`).join('');

      const start = (TABLE.page - 1) * TABLE.perPage;
      const rows = TABLE.filtered.slice(start, start + TABLE.perPage);
      body.innerHTML = rows.map(r => `
        <tr class="odd:bg-white even:bg-gray-50/70">
          ${cols.map(c => `<td class="px-3 py-2 whitespace-nowrap">${escapeHtml(String(c.get(r) ?? ''))}</td>`).join('')}
        </tr>
      `).join('');

      const maxPage = Math.max(1, Math.ceil(TABLE.filtered.length / TABLE.perPage));
      document.getElementById('page-label').textContent = `Page ${TABLE.page} / ${maxPage}`;
      document.getElementById('table-status').textContent = `${TABLE.filtered.length.toLocaleString()} rows` + (TABLE.filtered.length !== RAW.length ? ' (filtered)' : '');
    }

    function downloadCSV() {
      const cols = TABLE.cols.filter(c => TABLE.visibleCols.has(c.key));
      const header = cols.map(c => csvEscape(c.label)).join(',');
      const lines = TABLE.filtered.map(r => cols.map(c => csvEscape(c.get(r))).join(','));
      const csv = [header, ...lines].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'summary_statistics.csv';
      document.body.appendChild(a); a.click(); a.remove();
    }

    function csvEscape(v) {
      if (v == null) return '';
      const s = String(v);
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }

    function parseSci(txt) {
      if (!txt) return null;
      const t = String(txt).trim();
      if (t.toLowerCase() === 'all') return 1;
      const n = Number(t);
      if (!isNaN(n)) return n;
      // accept like 5e-8 with spaces
      const m = t.match(/^([0-9]*\.?[0-9]+)\s*e\s*([+-]?\d+)$/i);
      if (m) return Number(m[1]) * Math.pow(10, Number(m[2]));
      return null;
    }

    function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c])); }

    document.addEventListener('DOMContentLoaded', loadResults);
  </script>

</body>

</html>